!function(e){var t={},n=function(t,n){e.ya||(e.ya={}),e.ya[t]=n};!function(){function i(){if(c)throw new Error("'yandex-maps-bookmarks' is not configured properly. Use config() method to fix it.")}var r=null,o=null;!function(){var t={exports:{}},i={};!function(e){var n,r={NOT_RESOLVED:"NOT_RESOLVED",IN_RESOLVING:"IN_RESOLVING",RESOLVED:"RESOLVED"},o=function(){var t={trackCircularDependencies:!0,allowMultipleDeclarations:!0},i={},h=!1,_=[],p=function(e,t,o){o||(o=t,t=[]);var s=i[e];s||(s=i[e]={name:e,decl:n}),s.decl={name:e,prev:s.decl,fn:o,state:r.NOT_RESOLVED,deps:t,dependents:[],exports:n}},v=function(t,n,i){"string"==typeof t&&(t=[t]),h||(h=!0,f(w)),_.push({deps:t,cb:function(t,r){r?(i||s)(r):n.apply(e,t)}})},g=function(e){var t=i[e];return t?r[t.decl.state]:"NOT_DEFINED"},y=function(e){return!!i[e]},m=function(e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},b=function(){var e,t={};for(var n in i)i.hasOwnProperty(n)&&(e=i[n],(t[e.decl.state]||(t[e.decl.state]=[])).push(n));return t},w=function(){h=!1,I()},I=function(){var e,t=_,n=0;for(_=[];e=t[n++];)D(null,e.deps,[],e.cb)},D=function(e,t,n,r){var o=t.length;o||r([]);for(var s,c,u=[],d=function(e,t){if(t)return void r(null,t);if(!--o){for(var n,i=[],s=0;n=u[s++];)i.push(n.exports);r(i)}},l=0,f=o;l<f;){if(s=t[l++],"string"==typeof s){if(!i[s])return void r(null,a(s,e));c=i[s].decl}else c=s;u.push(c),O(c,n,d)}},O=function(n,i,o){if(n.state===r.RESOLVED)return void o(n.exports);if(n.state===r.IN_RESOLVING)return void(t.trackCircularDependencies&&l(n,i)?o(null,c(n,i)):n.dependents.push(o));if(n.dependents.push(o),n.prev&&!t.allowMultipleDeclarations)return void k(n,d(n));t.trackCircularDependencies&&(i=i.slice()).push(n);var s=!1,a=n.prev?n.deps.concat([n.prev]):n.deps;n.state=r.IN_RESOLVING,D(n,a,i,function(t,i){return i?void k(n,i):(t.unshift(function(e,t){return s?void o(null,u(n)):(s=!0,void(t?k(n,t):R(n,e)))}),void n.fn.apply({name:n.name,deps:n.deps,global:e},t))})},R=function(e,t){e.exports=t,e.state=r.RESOLVED;for(var i,o=0;i=e.dependents[o++];)i(t);e.dependents=n},k=function(e,t){e.state=r.NOT_RESOLVED;for(var n,i=0;n=e.dependents[i++];)n(null,t);e.dependents=[]};return{create:o,define:p,require:v,getState:g,isDefined:y,setOptions:m,getStat:b}},s=function(e){f(function(){throw e})},a=function(e,t){return Error(t?'Module "'+t.name+'": can\'t resolve dependence "'+e+'"':'Required module "'+e+"\" can't be resolved")},c=function(e,t){for(var n,i=[],r=0;n=t[r++];)i.push(n.name);return i.push(e.name),Error('Circular dependence has been detected: "'+i.join(" -> ")+'"')},u=function(e){return Error('Declaration of module "'+e.name+'" has already been provided')},d=function(e){return Error('Multiple declarations of module "'+e.name+'" have been detected')},l=function(e,t){for(var n,i=0;n=t[i++];)if(e===n)return!0;return!1},f=function(){var t=[],n=function(e){return 1===t.push(e)},i=function(){var e=t,n=0,i=t.length;for(t=[];n<i;)e[n++]()};if("object"==typeof process&&process.nextTick)return function(e){n(e)&&process.nextTick(i)};if(e.setImmediate)return function(t){n(t)&&e.setImmediate(i)};if(e.postMessage&&!e.opera){var r=!0;if(e.attachEvent){var o=function(){r=!1};e.attachEvent("onmessage",o),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",o)}if(r){var s="__modules"+ +new Date,a=function(e){e.data===s&&(e.stopPropagation&&e.stopPropagation(),i())};return e.addEventListener?e.addEventListener("message",a,!0):e.attachEvent("onmessage",a),function(t){n(t)&&e.postMessage(s,"*")}}}var c=e.document;if("onreadystatechange"in c.createElement("script")){var u=c.getElementsByTagName("head")[0],d=function(){var e=c.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,i()},u.appendChild(e)};return function(e){n(e)&&d()}}return function(e){n(e)&&setTimeout(i,0)}}();"object"==typeof i?t.exports=o():e.modules=o()}("undefined"!=typeof window?window:e),r=t.exports,n("modules",r)}(),function(){var t={exports:{}};!function(e){var n,i=function(){var t=[],n=function(e){return t.push(e),1===t.length},i=function(){var e=t,n=0,i=t.length;for(t=[];n<i;)e[n++]()};if("function"==typeof setImmediate)return function(e){n(e)&&setImmediate(i)};if("object"==typeof process&&process.nextTick)return function(e){n(e)&&process.nextTick(i)};var r=e.MutationObserver||e.WebKitMutationObserver;if(r){var o=1,s=document.createTextNode("");return new r(i).observe(s,{characterData:!0}),function(e){n(e)&&(s.data=o*=-1)}}if(e.postMessage){var a=!0;if(e.attachEvent){var c=function(){a=!1};e.attachEvent("onmessage",c),e.postMessage("__checkAsync","*"),e.detachEvent("onmessage",c)}if(a){var u="__promise"+Math.random()+"_"+new Date,d=function(e){e.data===u&&(e.stopPropagation&&e.stopPropagation(),i())};return e.addEventListener?e.addEventListener("message",d,!0):e.attachEvent("onmessage",d),function(t){n(t)&&e.postMessage(u,"*")}}}var l=e.document;if("onreadystatechange"in l.createElement("script")){var f=function(){var e=l.createElement("script");e.onreadystatechange=function(){e.parentNode.removeChild(e),e=e.onreadystatechange=null,i()},(l.documentElement||l.body).appendChild(e)};return function(e){n(e)&&f()}}return function(e){n(e)&&setTimeout(i,0)}}(),o=function(e){i(function(){throw e})},s=function(e){return"function"==typeof e},a=function(e){return null!==e&&"object"==typeof e},c=Object.prototype.toString,u=Array.isArray||function(e){return"[object Array]"===c.call(e)},d=function(e){for(var t=[],n=0,i=e.length;n<i;)t.push(n++);return t},l=Object.keys||function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t},f=function(e){var t=function(t){this.name=e,this.message=t};return t.prototype=new Error,t},h=function(e,t){return function(n){e.call(this,n,t)}},_=function(){this._promise=new v};_.prototype={promise:function(){return this._promise},resolve:function(e){this._promise.isResolved()||this._promise._resolve(e)},reject:function(e){this._promise.isResolved()||(m.isPromise(e)?(e=e.then(function(e){var t=m.defer();return t.reject(e),t.promise()}),this._promise._resolve(e)):this._promise._reject(e))},notify:function(e){this._promise.isResolved()||this._promise._notify(e)}};var p={PENDING:0,RESOLVED:1,FULFILLED:2,REJECTED:3},v=function(e){if(this._value=n,this._status=p.PENDING,this._fulfilledCallbacks=[],this._rejectedCallbacks=[],this._progressCallbacks=[],e){var t=this,i=e.length;e(function(e){t.isResolved()||t._resolve(e)},i>1?function(e){t.isResolved()||t._reject(e)}:n,i>2?function(e){t.isResolved()||t._notify(e)}:n)}};v.prototype={valueOf:function(){return this._value},isResolved:function(){return this._status!==p.PENDING},isFulfilled:function(){return this._status===p.FULFILLED},isRejected:function(){return this._status===p.REJECTED},then:function(e,t,n,i){var r=new _;return this._addCallbacks(r,e,t,n,i),r.promise()},"catch":function(e,t){return this.then(n,e,t)},fail:function(e,t){return this.then(n,e,t)},always:function(e,t){var n=this,i=function(){return e.call(this,n)};return this.then(i,i,t)},progress:function(e,t){return this.then(n,n,e,t)},spread:function(e,t,n){return this.then(function(t){return e.apply(this,t)},t,n)},done:function(e,t,n,i){this.then(e,t,n,i).fail(o)},delay:function(e){var t,n=this.then(function(n){var i=new _;return t=setTimeout(function(){i.resolve(n)},e),i.promise()});return n.always(function(){clearTimeout(t)}),n},timeout:function(e){var t=new _,n=setTimeout(function(){t.reject(new m.TimedOutError("timed out"))},e);return this.then(function(e){t.resolve(e)},function(e){t.reject(e)}),t.promise().always(function(){clearTimeout(n)}),t.promise()},_vow:!0,_resolve:function(e){if(!(this._status>p.RESOLVED)){if(e===this)return void this._reject(TypeError("Can't resolve promise with itself"));if(this._status=p.RESOLVED,e&&e._vow)return void(e.isFulfilled()?this._fulfill(e.valueOf()):e.isRejected()?this._reject(e.valueOf()):e.then(this._fulfill,this._reject,this._notify,this));if(a(e)||s(e)){var t;try{t=e.then}catch(n){return void this._reject(n)}if(s(t)){var i=this,r=!1;try{t.call(e,function(e){r||(r=!0,i._resolve(e))},function(e){r||(r=!0,i._reject(e))},function(e){i._notify(e)})}catch(n){r||this._reject(n)}return}}this._fulfill(e)}},_fulfill:function(e){this._status>p.RESOLVED||(this._status=p.FULFILLED,this._value=e,this._callCallbacks(this._fulfilledCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=n)},_reject:function(e){this._status>p.RESOLVED||(this._status=p.REJECTED,this._value=e,this._callCallbacks(this._rejectedCallbacks,e),this._fulfilledCallbacks=this._rejectedCallbacks=this._progressCallbacks=n)},_notify:function(e){this._callCallbacks(this._progressCallbacks,e)},_addCallbacks:function(e,t,i,r,o){i&&!s(i)?(o=i,i=n):r&&!s(r)&&(o=r,r=n);var a;this.isRejected()||(a={defer:e,fn:s(t)?t:n,ctx:o},this.isFulfilled()?this._callCallbacks([a],this._value):this._fulfilledCallbacks.push(a)),this.isFulfilled()||(a={defer:e,fn:i,ctx:o},this.isRejected()?this._callCallbacks([a],this._value):this._rejectedCallbacks.push(a)),this._status<=p.RESOLVED&&this._progressCallbacks.push({defer:e,fn:r,ctx:o})},_callCallbacks:function(e,t){var n=e.length;if(n){var r=this.isResolved(),o=this.isFulfilled(),s=this.isRejected();i(function(){for(var i,a,c,u=0;u<n;)if(i=e[u++],a=i.defer,c=i.fn){var d,l=i.ctx;try{d=l?c.call(l,t):c(t)}catch(f){a.reject(f);continue}r?a.resolve(d):a.notify(d)}else o?a.resolve(t):s?a.reject(t):a.notify(t)})}}};var g={cast:function(e){return m.cast(e)},all:function(e){return m.all(e)},race:function(e){return m.anyResolved(e)},resolve:function(e){return m.resolve(e)},reject:function(e){return m.reject(e)}};for(var y in g)g.hasOwnProperty(y)&&(v[y]=g[y]);var m={Deferred:_,Promise:v,defer:function(){return new _},when:function(e,t,n,i,r){return m.cast(e).then(t,n,i,r)},fail:function(e,t,i){return m.when(e,n,t,i)},always:function(e,t,n){return m.when(e).always(t,n)},progress:function(e,t,n){return m.when(e).progress(t,n)},spread:function(e,t,n,i){return m.when(e).spread(t,n,i)},done:function(e,t,n,i,r){m.when(e).done(t,n,i,r)},isPromise:function(e){return a(e)&&s(e.then)},cast:function(e){return e&&e._vow?e:m.resolve(e)},valueOf:function(e){return e&&s(e.valueOf)?e.valueOf():e},isFulfilled:function(e){return!e||!s(e.isFulfilled)||e.isFulfilled()},isRejected:function(e){return!(!e||!s(e.isRejected))&&e.isRejected()},isResolved:function(e){return!e||!s(e.isResolved)||e.isResolved()},resolve:function(e){var t=m.defer();return t.resolve(e),t.promise()},fulfill:function(e){var t=m.defer(),n=t.promise();return t.resolve(e),n.isFulfilled()?n:n.then(null,function(e){return e})},reject:function(e){var t=m.defer();return t.reject(e),t.promise()},invoke:function(t,n){var i,r=Math.max(arguments.length-1,0);if(r){i=Array(r);for(var o=0;o<r;)i[o++]=arguments[o]}try{return m.resolve(i?t.apply(e,i):t.call(e))}catch(s){return m.reject(s)}},all:function(e){var t=new _,n=u(e),i=n?d(e):l(e),r=i.length,o=n?[]:{};if(!r)return t.resolve(o),t.promise();var s=r;return m._forEach(e,function(e,n){o[i[n]]=e,--s||t.resolve(o)},t.reject,t.notify,t,i),t.promise()},allResolved:function(e){var t=new _,n=u(e),i=n?d(e):l(e),r=i.length,o=n?[]:{};if(!r)return t.resolve(o),t.promise();var s=function(){--r||t.resolve(e)};return m._forEach(e,s,s,t.notify,t,i),t.promise()},allPatiently:function(e){return m.allResolved(e).then(function(){var t,n,i,r,o=u(e),s=o?d(e):l(e),a=s.length,c=0;if(!a)return o?[]:{};for(;c<a;)i=s[c++],r=e[i],m.isRejected(r)?(t||(t=o?[]:{}),o?t.push(r.valueOf()):t[i]=r.valueOf()):t||((n||(n=o?[]:{}))[i]=m.valueOf(r));if(t)throw t;return n})},any:function(e){var t=new _,n=e.length;if(!n)return t.reject(Error()),t.promise();var i,r=0;return m._forEach(e,t.resolve,function(e){r||(i=e),++r===n&&t.reject(i)},t.notify,t),t.promise()},anyResolved:function(e){var t=new _,n=e.length;return n?(m._forEach(e,t.resolve,t.reject,t.notify,t),t.promise()):(t.reject(Error()),t.promise())},delay:function(e,t){return m.resolve(e).delay(t)},timeout:function(e,t){return m.resolve(e).timeout(t)},_forEach:function(e,t,n,i,r,o){for(var s=o?o.length:e.length,a=0;a<s;)m.when(e[o?o[a]:a],h(t,a),n,i,r),++a},TimedOutError:f("TimedOut")},b=!0;"object"==typeof t&&"object"==typeof t.exports&&(t.exports=m,b=!1),"object"==typeof r&&s(r.define)&&(r.define("vow",function(e){e(m)}),b=!1),"function"==typeof define&&(define(function(e,t,n){n.exports=m}),b=!1),b&&(e.vow=m)}("undefined"!=typeof window?window:e),o=t.exports,n("vow",o)}(),function(e){function t(e){var t=d(e);if(v)for(var n,i=0;n=m[i++];)e.hasOwnProperty(n)&&t.push(n);return t}function n(e,n,i){for(var r,o,a=t(i),c=0,u=a.length;c<u;)"__self"!==(r=a[c++])&&(o=i[r],_(o)&&(!s||o.toString().indexOf(".__base")>-1)?n[r]=function(t,i){var r=e[t]?e[t]:"__constructor"===t?n.__self.__parent:p;return function(){var e=this.__base;this.__base=r;var t=i.apply(this,arguments);return this.__base=e,t}}(r,o):n[r]=o)}function i(e,t){for(var n,i=1;n=e[i++];)t?_(n)?o.self(t,n.prototype,n):o.self(t,n):t=_(n)?o(e[0],n.prototype,n):o(e[0],n);return t||e[0]}function o(){var e=arguments,t=h(e[0]),r=t||_(e[0]),o=r?t?i(e[0]):e[0]:a,s=e[r?1:0]||{},c=e[r?2:1],d=s.__constructor||r&&o.prototype.__constructor?function(){return this.__constructor.apply(this,arguments)}:r?function(){return o.apply(this,arguments)}:function(){};if(!r)return d.prototype=s,d.prototype.__self=d.prototype.constructor=d,l(d,c);l(d,o),d.__parent=o;var f=o.prototype,p=d.prototype=u(f);return p.__self=p.constructor=d,s&&n(f,p,s),c&&n(o,d,c),d}var s=function(){"_"}.toString().indexOf("_")>-1,a=function(){},c=Object.prototype.hasOwnProperty,u=Object.create||function(e){var t=function(){};return t.prototype=e,new t},d=Object.keys||function(e){var t=[];for(var n in e)c.call(e,n)&&t.push(n);return t},l=function(e,t){for(var n in t)c.call(t,n)&&(e[n]=t[n]);return e},f=Object.prototype.toString,h=Array.isArray||function(e){return"[object Array]"===f.call(e)},_=function(e){return"[object Function]"===f.call(e)},p=function(){},v=!0,g={toString:""};for(var y in g)g.hasOwnProperty(y)&&(v=!1);var m=v?["toString","valueOf"]:null;o.self=function(){var e=arguments,t=h(e[0]),r=t?i(e[0],e[0][0]):e[0],o=e[1],s=e[2],a=r.prototype;return o&&n(a,a,o),s&&n(r,r,s),r};var b=!0;"object"==typeof exports&&(module.exports=o,b=!1),"object"==typeof r&&(r.define("inherit",function(e){e(o)}),b=!1),"function"==typeof define&&(define(function(e,t,n){n.exports=o}),b=!1),b&&(e.inherit=o)}(this),function(){function e(e,t,n){var i=t&&n||0,r=0;for(t=t||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,function(e){r<16&&(t[i+r++]=f[e])});r<16;)t[i+r++]=0;return t}function t(e,t){var n=t||0,i=l;return i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]}function n(e,n,i){var r=n&&i||0,o=n||[];e=e||{};var s=null!=e.clockseq?e.clockseq:v,a=null!=e.msecs?e.msecs:(new Date).getTime(),c=null!=e.nsecs?e.nsecs:y+1,u=a-g+(c-y)/1e4;if(u<0&&null==e.clockseq&&(s=s+1&16383),(u<0||a>g)&&null==e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");g=a,y=c,v=s,a+=122192928e5;var d=(1e4*(268435455&a)+c)%4294967296;o[r++]=d>>>24&255,o[r++]=d>>>16&255,o[r++]=d>>>8&255,o[r++]=255&d;var l=a/4294967296*1e4&268435455;o[r++]=l>>>8&255,o[r++]=255&l,o[r++]=l>>>24&15|16,o[r++]=l>>>16&255,o[r++]=s>>>8|128,o[r++]=255&s;for(var f=e.node||p,h=0;h<6;h++)o[r+h]=f[h];return n?n:t(o)}function i(e,n,i){var o=n&&i||0;"string"==typeof e&&(n="binary"==e?new d(16):null,e=null),e=e||{};var s=e.random||(e.rng||r)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,n)for(var a=0;a<16;a++)n[o+a]=s[a];return n||t(s)}var r,o=this;if("function"==typeof o.require)try{var s=o.require("crypto").randomBytes;r=s&&function(){return s(16)}}catch(a){}if(!r&&o.crypto&&crypto.getRandomValues){var c=new Uint8Array(16);r=function(){return crypto.getRandomValues(c),c}}if(!r){var u=new Array(16);r=function(){for(var e,t=0;t<16;t++)0===(3&t)&&(e=4294967296*Math.random()),u[t]=e>>>((3&t)<<3)&255;return u}}for(var d="function"==typeof o.Buffer?o.Buffer:Array,l=[],f={},h=0;h<256;h++)l[h]=(h+256).toString(16).substr(1),f[l[h]]=h;var _=r(),p=[1|_[0],_[1],_[2],_[3],_[4],_[5]],v=16383&(_[6]<<8|_[7]),g=0,y=0,m=i;if(m.v1=n,m.v4=i,m.parse=e,m.unparse=t,m.BufferClass=d,"undefined"!=typeof module&&module.exports)module.exports=m;else if("function"==typeof define&&define.amd)define(function(){return m});else{var b=o.uuid;m.noConflict=function(){return o.uuid=b,m},o.uuid=m}}.call(this),t.getBookmarksManager=function(){i();var e=o.defer();return r.require("bookmarks-manager",function(t){t.getInstance().done(function(t){e.resolve(t)},function(t){e.reject(t)})},function(t){e.reject(t)}),e.promise()},t.getPlacesManager=function(){i();var e=o.defer();return r.require("places-manager",function(t){t.getInstance().then(function(t){e.resolve(t)},function(t){e.reject(t)})},function(t){e.reject(t)}),e.promise()},t.getSearchHistoryManager=function(){i();var e=o.defer();return r.require("search-history-manager",function(t){t.getInstance().then(function(t){e.resolve(t)},function(t){e.reject(t)})},function(t){e.reject(t)}),e.promise()},t.getCarsManager=function(){i();var e=o.defer();return r.require("cars-manager",function(t){t.getInstance().then(function(t){e.resolve(t)},function(t){e.reject(t)})},function(t){e.reject(t)}),e.promise()},t.getTrucksManager=function(){i();var e=o.defer();return r.require("trucks-manager",function(t){t.getInstance().then(function(t){e.resolve(t)},function(t){e.reject(t)})},function(t){e.reject(t)}),e.promise()},t.getRoutesPointsHistoryManager=function(){i();var e=o.defer();return r.require("routes-pointshistory-manager",function(t){t.getInstance().then(function(t){e.resolve(t)},function(t){e.reject(t)})},function(t){e.reject(t)}),e.promise()},t.getRoutesRideHistoryManager=function(){i();var e=o.defer();return r.require("routes-ridehistory-manager",function(t){t.getInstance().then(function(t){e.resolve(t)},function(t){e.reject(t)})},function(t){e.reject(t)}),e.promise()},t.getMasstransitManager=function(){i();var e=o.defer();return r.require("masstransit-manager",function(t){t.getInstance().then(function(t){e.resolve(t)},function(t){e.reject(t)})},function(t){e.reject(t)}),e.promise()};var s={favoritesTitle:"",cloudApiUrl:"",useClientStorage:!0,backgroundSync:void 0,filterDublicate:!1},a={ru:"Избранное",en:"Favorites",tr:"Favori̇ler",uk:"Вибране",kk:"Таңдаулы",uz:"Tanlangan"},c=!0;t.config=function(e){e.lang&&a[e.lang]&&(s.favoritesTitle=a[e.lang]),e.cloudApiUrl&&(s.cloudApiUrl=e.cloudApiUrl),s.favoritesTitle&&s.cloudApiUrl&&(c=!1),e.hasOwnProperty("useClientStorage")&&(s.useClientStorage=e.useClientStorage),e.hasOwnProperty("backgroundSync")&&(s.backgroundSync=e.backgroundSync),e.hasOwnProperty("filterDublicate")&&(s.filterDublicate=e.filterDublicate)},r.define("config",function(e){e(s)});var u={ROOT_FOLDER_ID:"the_root_folder",FAVORITES_FOLDER_ID:"the_favorites_folder",HOME_ID:"home",WORK_ID:"work",FOLDER_TAGS:{SHOW_ON_MAP:"show-on-map"}};t.ROOT_FOLDER_ID=u.ROOT_FOLDER_ID,t.FAVORITES_FOLDER_ID=u.FAVORITES_FOLDER_ID,t.HOME_ID=u.HOME_ID,t.WORK_ID=u.WORK_ID,t.FOLDER_TAGS=u.FOLDER_TAGS,r.define("constant-ids",function(e){e(u)}),r.define("bookmark-db-params",["constant-ids"],function(e,t){e({DATABASE_ID:".ext.maps_common@ymapsbookmarks1",COLLECTION_ID:"bookmarks",ROOT_FOLDER_ID:t.ROOT_FOLDER_ID,FAVORITES_FOLDER_ID:t.FAVORITES_FOLDER_ID,FOLDER_TAGS:t.FOLDER_TAGS})}),r.define("bookmark-db-reader",["inherit","bookmark-db-params","transaction-utils","config"],function(e,t,n,i,r){function o(e){var t=e.getFieldValue("title"),n=e.getFieldValue("children");return void 0!==t&&"string"===t.getType()&&void 0!==n&&"list"===n.getType()}function s(e){var t=e.getFieldValue("uri"),n=e.getFieldValue("title"),i=e.getFieldValue("tags"),o=!r.filterDublicate||(!i||!i.valueOf().toString().includes("maps:duplicate"));return void 0!==t&&"string"===t.getType()&&void 0!==n&&"string"===n.getType()&&o}function a(e){var t=e.getFieldValue("description"),n=e.getFieldValue("comment");return{id:e.getRecordId(),title:e.getFieldValue("title").valueOf(),uri:e.getFieldValue("uri").valueOf(),description:t&&t.valueOf(),comment:n&&n.valueOf()}}var c=t({__constructor:function(e){this._db=e,this._repairTransaction=null},read:function(){this._repairTransaction=this._db.createTransaction(),this._viewedRecords={},this._viewedRecords[n.ROOT_FOLDER_ID]=!0;var e,t=this._db.getRecord(n.COLLECTION_ID,n.ROOT_FOLDER_ID);t&&o(t)?e=this._createFolderData(t):(e={id:n.ROOT_FOLDER_ID,title:"",children:[]},this._resetFolder(e));var s=e.children.find(function(e){return e.id===n.FAVORITES_FOLDER_ID});if(!s){var a=this._db.getRecord(n.COLLECTION_ID,n.FAVORITES_FOLDER_ID);a&&o(a)?s=this._createFolderData(a):(s={id:n.FAVORITES_FOLDER_ID,title:r.favoritesTitle,children:[],tags:[n.FOLDER_TAGS.SHOW_ON_MAP]},this._resetFolder(s)),e.children.unshift(s),i.prependChild(this._repairTransaction,n.ROOT_FOLDER_ID,n.FAVORITES_FOLDER_ID),this._viewedRecords[n.FAVORITES_FOLDER_ID]=!0}this._collectOrphanChildren(s,e);var c={rootData:e,repairOperations:this._repairTransaction.getOperations()};return this._viewedRecords=null,this._repairTransaction=null,c},_createChildren:function(e){var t=[],i={};return e.getFieldValue("children").valueOf().forEach(function(r,c){if("string"!==r.getType())return void this._removeChild(e,c);var u=r.valueOf();if(i[u])return void this._removeChild(e,c);i[u]=!0;var d=this._db.getRecord(n.COLLECTION_ID,u);return d?this._viewedRecords[u]?void this._removeChild(e,c):(this._viewedRecords[u]=!0,void(o(d)?t.push(this._createFolderData(d)):s(d)?t.push(a(d)):(this._repairTransaction.deleteRecords(d),this._removeChild(e,c)))):void this._removeChild(e,c)},this),t},_createFolderData:function(e){var t={id:e.getRecordId(),title:e.getFieldValue("title").valueOf(),children:this._createChildren(e)},n=e.getFieldValue("tags"),i=e.getFieldValue("description"),r=e.getFieldValue("icon");return n&&(t.tags=n.valueOf().map(function(e){return e._value})),i&&(t.description=i.valueOf()),r&&(t.icon=r.valueOf()),t},_collectOrphanChildren:function(e,t){this._db.forEach(n.COLLECTION_ID,function(r){var c=r.getRecordId();this._viewedRecords[c]||(o(r)?(t.children.unshift(this._createFolderData(r)),i.prependChild(this._repairTransaction,n.ROOT_FOLDER_ID,c)):s(r)?(e.children.unshift(a(r)),i.prependChild(this._repairTransaction,n.FAVORITES_FOLDER_ID,c)):this._repairTransaction.deleteRecords(r))},this)},_removeChild:function(e,t){this._repairTransaction.deleteRecordFieldListItem(e,{field_id:"children",index:t})},_resetFolder:function(e){var t=[{field_id:"title",type:"set",value:e.title},{field_id:"children",type:"set",value:[]}];void 0!==e.tags&&t.push({field_id:"tags",type:"set",value:e.tags}),this._repairTransaction.addOperations({collection_id:n.COLLECTION_ID,record_id:e.id,type:"set",field_operations:t})}});e(c)}),r.define("places-db-params",["constant-ids"],function(e,t){e({DATABASE_ID:".ext.profile@addresses",COLLECTION_ID:"common_addresses",HOME_ID:t.HOME_ID,WORK_ID:t.WORK_ID})}),r.define("places-db-reader",["inherit","places-db-params"],function(e,t,n){function i(e){return r(e)&&o(e)}function r(e){for(var t=["title","latitude","longitude","created","modified","last_used"],n=["string","double","double","datetime","datetime","datetime"],i=0;i<t.length;i++){var r=e.getFieldValue(t[i]);if(!r||r.getType()!==n[i])return!1}return!0}function o(e){for(var t=["tags","address_line","address_line_short"],n=["list","string","string"],i=0;i<t.length;i++){var r=e.getFieldValue(t[i]);if(r&&r.getType()!==n[i])return!1}var o=e.getFieldValue("tags");return!o||s(o.valueOf())}function s(e){for(var t=0;t<e.length;t++)if("string"!==e[t].getType())return!1;return!0}var a=t({__constructor:function(e){this._db=e},read:function(){var e=[],t=this._db.createTransaction();return this._db.forEach(n.COLLECTION_ID,function(n){i(n)?e.push(n):t.deleteRecords(n)},this),{placeRecords:e,repairOperations:t.getOperations()}}});e(a)}),r.define("transaction-utils",["bookmark-db-params","assert"],function(e,t,n){e({prependChild:function(e,t,n){this.insertChild(e,t,n,0)},insertChild:function(e,n,i,r){e.insertRecordFieldListItem({collection_id:t.COLLECTION_ID,record_id:n},{field_id:"children",index:r,value:i})},removeChildFromFolder:function(e,i,r,o){var s=e.getRecord(t.COLLECTION_ID,r),a=s.getFieldValue("children").valueOf(),c=a.findIndex(function(e){return e.valueOf()===o});n(c>=0,"There is no record with id `%s` in folder `%s`",o,r),i.deleteRecordFieldListItem(s,{field_id:"children",index:c})},updateChildPosition:function(e,n,i,r){e.moveRecordFieldListItem({collection_id:t.COLLECTION_ID,record_id:n},{field_id:"children",index:i,new_index:r})}})}),r.define("abstract-db-manager",["inherit","event-emitter","data-sync-delta-parser","data-sync-delta-serializer","data-sync-rebase","bookmarks-update-scheduler"],function(e,t,n,i,r,o,s){var a=409,c=t(n,{__constructor:function(e){this._db=e,this._revision=e.getRevision(),this._repairOperations=null,this._updateScheduler=null,this._syncPromise=null},getRevision:function(){return this._revision},update:function(){return this.isSyncing()?this._syncPromise:this._setSyncPromise(this._db.update())},isSyncing:function(){return this._syncPromise&&!this._syncPromise.isResolved()},createUpdateInterval:function(){return this._updateScheduler||(this._updateScheduler=new s(this)),this._updateScheduler.createInterval()},_createTransaction:function(){var e=this._db.createTransaction();return this._repairOperations&&(e.addOperations(this._repairOperations),this._repairOperations=null),e},_pushTransaction:function(e){return this._setSyncPromise(this._push(e))},_push:function(e){return e.push()["catch"](function(t){if(t.code===a){var n=i.parseOperations(e.getOperations()),s=i.parseRevisionHistory(t.revisionHistory),c=o(n,s);if(c.isEmpty())return;var u=this._db.createTransaction();return u.addOperations(r.toOperations(c)),this._push(u)}throw t},this)},_setSyncPromise:function(e){return this.emit("sync-start"),this._syncPromise=e.always(function(){this.emit("sync-finish")},this),e}});e(c)}),r.define("bookmarks-manager",["inherit","abstract-db-manager","bookmark-db-params","bookmark-db-reader","data-sync-api","uuid","transaction-utils","assert","config"],function(e,t,n,i,r,o,s,a,c,u){function d(){return s.v4()}function l(e,t){if(t(e))return e;for(var n=null,i=e.children,r=0,o=i.length;r<o;r++){var s=i[r];if(s.children?n=l(s,t):t(s)&&(n=s),n)break}return n}var f=t(n,{__constructor:function(e){this.__base(e),this._dbReader=new r(e),e.on("update",this._onDbUpdate.bind(this)),this._updateData()},get:function(e){return this._dataIndex[e]||null},getRootFolder:function(){return this._dataIndex[i.ROOT_FOLDER_ID]},getFavoritesFolder:function(){return this._dataIndex[i.FAVORITES_FOLDER_ID]},getParentFor:function(e){this._assertChild(e);var t=this._parentIndex[e];return t?this._dataIndex[t]:null},addBookmark:function(e,t){t=t||{};var n=t.parentId||i.FAVORITES_FOLDER_ID;this._assertFolder(n);var r=this._createTransaction();const o=this._addBookmark(r,Object.assign({},e,{parentId:n,index:t.index||0}));return this._pushTransaction(r).then(function(e){return{transactionId:e,bookmarkId:o}})},addBookmarkToFolders:function(e,t){t=t||{};for(var n=t.parentIds||[],i=this._createTransaction(),r="",o=0;o<n.length;o++){var s=n[o];this._assertFolder(s),r=this._addBookmark(i,Object.assign({},e,{parentId:s,index:t.index||0}))}return this._pushTransaction(i).then(function(e){return{transactionId:e,bookmarkId:r}})},addBookmarkToNewFolder:function(e,t,n){n=n||{};var r=n.parentId||i.ROOT_FOLDER_ID;this._assertFolder(r);var o=this._createTransaction(),s=this._addFolder(o,Object.assign({},t,{parentId:r}));const a=this._addBookmark(o,Object.assign({},e,{parentId:s,index:0}));return this._pushTransaction(o).then(function(e){return{transactionId:e,folderId:s,bookmarkId:a}})},updateBookmark:function(e,t){this._assertBookmark(e);var n=this._createTransaction(),r={};return["uri","title","description","comment"].forEach(function(e){var n=t[e];void 0!==n&&(r[e]={type:"string",value:n})}),n.updateRecordFields({collection_id:i.COLLECTION_ID,record_id:e},r),this._pushTransaction(n)},addFolder:function(e,t,n){t=t||{};var r=t.parentId||i.ROOT_FOLDER_ID;this._assertFolder(r);var o=this._createTransaction();const s=this._addFolder(o,Object.assign({},e,{parentId:r}));return this._pushTransaction(o).then(function(e){return{transactionId:e,folderId:s}})},updateFolder:function(e,t){this._assertFolder(e);var n=this._createTransaction(),r={};return void 0!==t.title&&(r.title={type:"string",value:t.title}),void 0!==t.description&&(r.description={type:"string",value:t.description}),void 0!==t.tags&&(r.tags={type:"list",value:t.tags}),void 0!==t.icon&&(r.icon={type:"string",value:t.icon}),n.updateRecordFields({collection_id:i.COLLECTION_ID,record_id:e},r),this._pushTransaction(n)},updateChildOrder:function(e,t){var n=this._createTransaction();return t.forEach(function(t){var i=t[0],r=t[1];a.updateChildPosition(n,e,i,r)}),this._pushTransaction(n)},removeChild:function(e,t){this._assertChild(e),this._assertParent(e);var n=this._createTransaction(),r=[{collection_id:i.COLLECTION_ID,record_id:e}],o=this._db.getRecord(i.COLLECTION_ID,e);return o.getFieldValue("children")&&this._collectChildrenRecords(o,r),n.deleteRecords(r),t=t||this._parentIndex[e],a.removeChildFromFolder(this._db,n,t,e),this._pushTransaction(n)},moveChild:function(e,t,n){this._assertChild(e),this._assertParent(e),this._assertFolder(t);var i=this._createTransaction();return a.removeChildFromFolder(this._db,i,t,e),a.prependChild(i,n,e,0),this._pushTransaction(i)},moveChildToNewFolder:function(e,t,n){n=n||i.ROOT_FOLDER_ID,this._assertChild(e),this._assertParent(e),this._assertFolder(n);var r=this._createTransaction(),o=this._addFolder(r,Object.assign({},t,{parentId:n}));return a.removeChildFromFolder(this._db,r,this._parentIndex[e],e),a.prependChild(r,o,e),this._pushTransaction(r)},_addBookmark:function(e,t){var n=d(),r={title:{type:"string",value:t.title},uri:{type:"string",value:t.uri}};return void 0!==t.description&&(r.description={type:"string",value:t.description}),void 0!==t.comment&&(r.comment={type:"string",value:t.comment}),e.insertRecords({collection_id:i.COLLECTION_ID,record_id:n,fields:r}),a.insertChild(e,t.parentId,n,t.index||0),n},_addFolder:function(e,t){var n=t.id||d(),r={title:{type:"string",value:t.title},children:[]};return void 0!==t.description&&(r.description={type:"string",value:t.description}),void 0!==t.tags&&(r.tags={type:"list",value:t.tags}),void 0!==t.icon&&(r.icon={type:"string",value:t.icon}),e.insertRecords({collection_id:i.COLLECTION_ID,record_id:n,fields:r}),a.insertChild(e,t.parentId,n,this.get(t.parentId).children.length),n},_collectChildrenRecords:function(e,t){var n=e.getFieldValue("children").valueOf();n.forEach(function(e){var n=this._db.getRecord(i.COLLECTION_ID,e.valueOf()),r=n.getFieldValue("children");r&&this._collectChildrenRecords(n,t),t.push(n)},this)},findByUri:function(e){return l(this.getRootFolder(),function(t){return!t.children&&t.uri===e})},_onDbUpdate:function(e){this._revision!==e&&(this._revision=e,this._updateData(),this.emit("bookmarks-update"))},_updateData:function(){var e=this._dbReader.read();this._repairOperations=e.repairOperations,this._dataIndex={},this._parentIndex={},this._indexFolderDeep(e.rootData)},_indexFolderDeep:function(e){this._dataIndex[e.id]=e,e.children.forEach(function(t){this._parentIndex[t.id]=e.id,t.children?this._indexFolderDeep(t):this._dataIndex[t.id]=t},this)},_assertBookmark:function(e){c(this._dataIndex[e]&&!this._dataIndex[e].children,"There is no bookmark with id `%s`",e)},_assertFolder:function(e){c(this._dataIndex[e]&&this._dataIndex[e].children,"There is no folder with id `%s`",e)},_assertChild:function(e){c(this._dataIndex[e],"There is no record with id `%s`",e)},_assertParent:function(e){c(this._parentIndex[e],"Unable to find parent id for `%s`",e);
}},{_instancePromise:null,getInstance:function(){return this._instancePromise||(this._instancePromise=o.load().then(function(e){return e.openDatabase({database_id:i.DATABASE_ID,use_client_storage:u.useClientStorage,background_sync:u.backgroundSync,context:"app"}).then(function(e){return new f(e)},function(e){throw e})})),this._instancePromise}});e(f)}),r.define("bookmarks-update-scheduler",["inherit"],function(e,t){var n=t({__constructor:function(e){this._scheduler=e,e.schedule()},destruct:function(){this._scheduler&&(this._scheduler.unschedule(),this._scheduler=null)}}),i=t({__constructor:function(e){this._manager=e,this._intervalCount=0,this._timeoutId=0},schedule:function(){this._intervalCount||(this._manager.on("sync-start",this._cancelScheduledUpdate,this).on("sync-finish",this._scheduleUpdate,this),this._manager.isSyncing()||this._scheduleUpdate()),this._intervalCount++},unschedule:function(){this._intervalCount--,this._intervalCount||(this._manager.off("sync-start",this._cancelScheduledUpdate,this).off("sync-finish",this._scheduleUpdate,this),this._cancelScheduledUpdate())},createInterval:function(){return new n(this)},_scheduleUpdate:function(){this._timeoutId=setTimeout(function(){this._timeoutId=0,this._manager.update()}.bind(this),this.__self.UPDATE_TIMEOUT_MS)},_cancelScheduledUpdate:function(){this._timeoutId&&(clearTimeout(this._timeoutId),this._timeoutId=0)}},{UPDATE_TIMEOUT_MS:3e5});e(i)}),r.define("cars-manager",["abstract-db-manager","data-sync-api","inherit","uuid","assert","config"],function(e,t,n,i,r,o,s){function a(e){const t=e.getFields(),n=Object.keys(t).reduce(function(t,n){return e.getFieldValue(n)&&(t[n]=e.getFieldValue(n).valueOf()),t},{});return n.id=e.getRecordId(),n}function c(e){return Object.keys(e).reduce(function(t,n){if("id"===n)return t;var i=f[n];return i?t[n]={type:f[n],value:e[n]}:t[n]=e[n],t},{})}var u=".ext.maps_common@ynavicarinfo",d="cars",l=i(t,{__constructor:function(e){this.__base(e),this._db.on("update",this._onDbUpdate.bind(this)),this._cars=[],this._updateData()},getDefaultCar:function(){const e=this._cars.find(function(e){if(e.isDefaultCar)return e});return e||this._cars[0]},setDefaultCar:function(e){var t=this.getDefaultCar();if(t&&t.id===e&&t.isDefaultCar)return Promise.resolve(0);try{this._assertCar(e)}catch(n){return Promise.reject(n)}var i=this._cars.find(function(t){if(t.id===e)return t});i.isDefaultCar=!0;var r=this._createTransaction();return t&&this._updateCarRecord(r,{id:t.id,title:t.title,licensePlateNumber:t.licensePlateNumber,isDefaultCar:!1}),this._updateCarRecord(r,i),this._pushTransaction(r)},getAllCars:function(){return this._cars},addCar:function(e){var t=this._createTransaction();return 0===this._cars.length&&(e.isDefaultCar=!0),this._setDefaultIfNone(t),this._addCar(t,e),this._pushTransaction(t)},addCars:function(e){if(0===e.length)return Promise.resolve(0);var t=this._createTransaction();return this._setDefaultIfNone(t),e.forEach(function(e,n){0===this._cars.length&&0===n&&(e.isDefaultCar=!0),this._addCar(t,e)},this),this._pushTransaction(t)},_setDefaultIfNone:function(e){var t=this.getDefaultCar();t&&!t.isDefaultCar&&(t.isDefaultCar=!0,this._updateCarRecord(e,t))},_addCar:function(e,t){var n=c(t);e.insertRecords({collection_id:d,record_id:r.v4(),fields:n})},editCar:function(e){var t=this.getDefaultCar(),n={id:e.id,title:e.title,licensePlateNumber:e.licensePlateNumber,isDefaultCar:Boolean(t&&t.id===e.id)},i=this._createTransaction();return t&&t.id!==e.id&&!t.isDefaultCar&&(t.isDefaultCar=!0,this._updateCarRecord(i,t)),this._updateCarRecord(i,n),this._pushTransaction(i)},removeCar:function(e){try{this._assertCar(e)}catch(t){return Promise.reject(t)}var n=this.getDefaultCar(),i=this._createTransaction();if(i.deleteRecords({collection_id:d,record_id:e}),n&&this._cars.length>1)if(n.id===e){var r;r=this._cars[0].id===e?this._cars[1]:this._cars[0],r.isDefaultCar=!0,this._updateCarRecord(i,r)}else n.isDefaultCar||(n.isDefaultCar=!0,this._updateCarRecord(i,n));return this._pushTransaction(i)},_updateCarRecord:function(e,t){this._assertCar(t.id);var n=c(t);e.updateRecordFields({collection_id:d,record_id:t.id},n)},_updateData:function(){this._cars=[],this._db.forEach(d,function(e){this._cars.push(a(e))},this)},_onDbUpdate:function(e){this._revision!==e&&(this._revision=e,this._updateData(),this.emit("cars-update"))},_assertCar:function(e){o(this._cars.find(function(t){return t.id===e}),"There is no car with record-id `%s`",e)}},{_instancePromise:null,getInstance:function(){return this._instancePromise||(this._instancePromise=n.load().then(function(e){return e.openDatabase({database_id:u,background_sync:s.backgroundSync,context:"app"}).then(function(e){return new l(e)})})),this._instancePromise}}),f={isDefaultCar:"boolean",title:"string",licensePlateNumber:"string"};e(l)}),r.define("masstransit-manager",["abstract-db-manager","data-sync-api","inherit","uuid","assert","config"],function(e,t,n,i,r,o,s){function a(e){return"list"===e.getType()?e.valueOf().reduce(function(e,t){return"string"===t.getType()&&e.push(t.valueOf()),e},[]):void 0}function c(e){return{recordId:e.getRecordId(),stopId:e.getFieldValue("stop_id").valueOf(),coordinates:[e.getFieldValue("longitude").valueOf(),e.getFieldValue("latitude").valueOf()],title:e.getFieldValue("mt_info_title")&&e.getFieldValue("mt_info_title").valueOf(),tags:e.getFieldValue("tags")&&a(e.getFieldValue("tags")),transportTypes:e.getFieldValue("transport_type")&&a(e.getFieldValue("transport_type")),showOnMap:e.getFieldValue("show_on_map")&&e.getFieldValue("show_on_map").valueOf()}}function u(e){return{recordId:e.getRecordId(),lineId:e.getFieldValue("line_id").valueOf(),title:e.getFieldValue("title").valueOf(),transportTypes:e.getFieldValue("type2")&&a(e.getFieldValue("type2"))||e.getFieldValue("type")&&[e.getFieldValue("type").valueOf()]||[],uri:e.getFieldValue("uri")&&e.getFieldValue("uri").valueOf(),tags:e.getFieldValue("tags")&&a(e.getFieldValue("tags")),showOnMap:e.getFieldValue("show_on_map")&&e.getFieldValue("show_on_map").valueOf()}}function d(e,t){var n={},i=function(e,t,i){void 0!==e&&(n[t]={type:i,value:e})},r=e.transportTypes&&e.transportTypes.map(function(e){return{type:"string",value:e}});if(e.tags){var o=e.tags.map(function(e){return{type:"string",value:e}});n.tags={type:"list",value:o}}return i(e.showOnMap,"show_on_map","boolean"),t===f?(i(e.stopId,"stop_id","string"),i(e.coordinates&&e.coordinates[0],"longitude","double"),i(e.coordinates&&e.coordinates[1],"latitude","double"),i(e.title,"mt_info_title","string"),i(r,"transport_type","list")):t===h&&(i(e.lineId,"line_id","string"),i(e.title,"title","string"),i(e.uri,"uri","string"),i(r,"type2","list"),i(e.transportTypes&&e.transportTypes[0],"type","string")),n}var l=".ext.maps_common@ytransportmasstransit1",f="stop",h="transport",_=i(t,{__constructor:function(e){this.__base(e),this._db.on("update",this._onDbUpdate.bind(this)),this._updateData()},getAllStops:function(){return this._stops},getAllLines:function(){return this._lines},addStop:function(e){var t=this._createTransaction();return t.insertRecords({collection_id:f,record_id:r.v4(),fields:d(e,f)}),this._pushTransaction(t)},addLine:function(e){var t=this._createTransaction();return t.insertRecords({collection_id:h,record_id:r.v4(),fields:d(e,h)}),this._pushTransaction(t)},removeStop:function(e){this._assertStop(e);var t=this._createTransaction();return t.deleteRecords({collection_id:f,record_id:e}),this._pushTransaction(t)},removeLine:function(e){this._assertLine(e);var t=this._createTransaction();return t.deleteRecords({collection_id:h,record_id:e}),this._pushTransaction(t)},_updateData:function(){this._stops={},this._lines={},this._db.forEach(f,function(e){this._stops[e.getRecordId()]=c(e)},this),this._db.forEach(h,function(e){this._lines[e.getRecordId()]=u(e)},this)},_onDbUpdate:function(e){this._revision!==e&&(this._revision=e,this._updateData(),this.emit("masstransit-update"))},_assertLine:function(e){o(this._lines[e],"There is no line with record-id `%s`",e)},_assertStop:function(e){o(this._stops[e],"There is no stop with record-id `%s`",e)}},{_instancePromise:null,getInstance:function(){return this._instancePromise||(this._instancePromise=n.load().then(function(e){return e.openDatabase({database_id:l,background_sync:s.backgroundSync,context:"app"}).then(function(e){return new _(e)},function(e){throw e})})),this._instancePromise}});e(_)}),r.define("places-manager",["inherit","abstract-db-manager","data-sync-api","places-db-params","places-db-reader","uuid","assert","config"],function(e,t,n,i,r,o,s,a,c){function u(e){var t=e.getFieldValue("address_line"),n=e.getFieldValue("address_line_short"),i=[e.getFieldValue("longitude").valueOf(),e.getFieldValue("latitude").valueOf()];return{id:e.getRecordId(),title:e.getFieldValue("title").valueOf(),coords:i,created:new Date(e.getFieldValue("created").valueOf()),modified:new Date(e.getFieldValue("modified").valueOf()),lastUsed:new Date(e.getFieldValue("last_used").valueOf()),tags:d(e),addressLine:t&&t.valueOf(),addressLineShort:n&&n.valueOf()}}function d(e){var t=e.getFieldValue("tags");if(t&&"list"===t.getType()){var n=[],i=t.valueOf();return i.forEach(function(e){"string"===e.getType()&&n.push(e.valueOf())}),n}}function l(e){var t={},n=function(e,n,i){void 0!==e&&(t[n]={type:i,value:e})};if(n(e.title,"title","string"),e.coords&&(n(e.coords[0],"longitude","double"),n(e.coords[1],"latitude","double")),n(e.created,"created","datetime"),n(e.modified,"modified","datetime"),n(e.lastUsed,"last_used","datetime"),n(e.addressLine,"address_line","string"),n(e.addressLineShort,"address_line_short","string"),e.tags){var i=e.tags.map(function(e){return{type:"string",value:e}});t.tags={type:"list",value:i}}return t}var f=t(n,{__constructor:function(e){this.__base(e),this._dbReader=new o(e),this._db.on("update",this._onDbUpdate.bind(this)),this._updateData()},get:function(e){return this._places[e]||null},getAll:function(){return this._places},addPlace:function(e,t){t=t||s.v4(),this._assertNoPlace(t);var n=this._createTransaction();return n.insertRecords({collection_id:r.COLLECTION_ID,record_id:t,fields:l(e)}),this._pushTransaction(n)},updatePlace:function(e,t){this._assertPlace(e);var n=this._createTransaction();return n.updateRecordFields({collection_id:r.COLLECTION_ID,record_id:e},l(t)),this._pushTransaction(n)},removePlace:function(e){this._assertPlace(e);var t=this._createTransaction();return t.deleteRecords({collection_id:r.COLLECTION_ID,record_id:e}),this._pushTransaction(t)},_updateData:function(){var e=this._dbReader.read();this._placeRecords=e.placeRecords,this._repairOperations=e.repairOperations,this._places={},e.placeRecords.forEach(function(e){this._places[e.getRecordId()]=u(e)},this)},_onDbUpdate:function(e){this._revision!==e&&(this._revision=e,this._updateData(),this.emit("places-update"))},_assertPlace:function(e){a(this._places[e],"There is no place with id `%s`",e)},_assertNoPlace:function(e){a(!this._places[e],"Place with id `%s` already exists",e)}},{_instancePromise:null,getInstance:function(){return this._instancePromise||(this._instancePromise=i.load().then(function(e){return e.openDatabase({database_id:r.DATABASE_ID,use_client_storage:c.useClientStorage,background_sync:c.backgroundSync,context:"app"}).then(function(e){return new f(e)},function(e){throw e})})),this._instancePromise}});e(f)}),r.define("routes-pointshistory-manager",["abstract-db-manager","data-sync-api","inherit","geo-utils","uuid","config"],function(e,t,n,i,r,o,s){var a=".ext.maps_common@ymapspointshistory1",c="pointshistory",u=100,d=i(t,{__constructor:function(e){this.__base(e),this._readDb(),e.on("update",this._onDbUpdate.bind(this))},getRecords:function(){return this._records.map(function(e){var t=e.getFieldValue("uri");return{title:e.getFieldValue("title").valueOf(),description:e.getFieldValue("description").valueOf(),coordinates:[e.getFieldValue("longitude").valueOf(),e.getFieldValue("latitude").valueOf()],uri:t&&t.valueOf()}})},deleteRecords:function(){var e=this._createTransaction();const t=this._records.splice(0,this._records.length).map(function(e){return{collection_id:c,record_id:e.getRecordId()}});return e.deleteRecords(t),this._pushTransaction(e)},addRecord:function(e){var t=this._createTransaction(),n=this._records.find(function(t){return t.getFieldValue("title").valueOf()===e.title&&r.areSameCoordinates(t.getFieldValue("longitude").valueOf(),e.coordinates[0])&&r.areSameCoordinates(t.getFieldValue("latitude").valueOf(),e.coordinates[1])});if(n)t.updateRecordFields({collection_id:c,record_id:n.getRecordId()},{last_used:{type:"datetime",value:(new Date).toISOString()}});else{if(this._records.length>=u){var i=this._records.splice(u-1).map(function(e){return{collection_id:c,record_id:e.getRecordId()}});t.deleteRecords(i)}t.insertRecords({collection_id:c,record_id:o.v4(),fields:this._convertParamsToRecordFields(e)})}return this._pushTransaction(t)},_convertParamsToRecordFields:function(e){var t={title:{type:"string",value:e.title},description:{type:"string",value:e.description},longitude:{type:"double",value:e.coordinates[0]},latitude:{type:"double",value:e.coordinates[1]},last_used:{type:"datetime",value:(new Date).toISOString()}};return e.uri&&(t.uri={type:"string",value:e.uri}),t},_onDbUpdate:function(e){this._revision!==e&&(this._revision=e,this._readDb())},_readDb:function(){this._records=[],this._db.forEach(c,function(e){this._records.push(e)},this),this._records.sort(function(e,t){var n=new Date(e.getFieldValue("last_used").valueOf()),i=new Date(t.getFieldValue("last_used").valueOf());return n>i?-1:1})}},{getInstance:function(){return n.load().then(function(e){return e.openDatabase({database_id:a,background_sync:s.backgroundSync,context:"app"}).then(function(e){return new d(e)})})}});e(d)}),r.define("routes-ridehistory-manager",["abstract-db-manager","data-sync-api","inherit","geo-utils","uuid","config"],function(e,t,n,i,r,o,s){var a=".ext.maps_common@ymapsridehistory1",c="ridehistory",u=200,d=i(t,{__constructor:function(e){this.__base(e),this._readDb(),e.on("update",this._onDbUpdate.bind(this))},getRecords:function(){return this._records.map(function(e){var t=e.getFieldValue("from_point_context"),n=e.getFieldValue("to_point_context"),i=e.getFieldValue("ride_type");return{from:{title:e.getFieldValue("from_title").valueOf(),description:e.getFieldValue("from_description").valueOf(),coordinates:[e.getFieldValue("from_longitude").valueOf(),e.getFieldValue("from_latitude").valueOf()],country:e.getFieldValue("from_country").valueOf(),pctx:t&&t.valueOf()},to:{title:e.getFieldValue("to_title").valueOf(),description:e.getFieldValue("to_description").valueOf(),coordinates:[e.getFieldValue("to_longitude").valueOf(),e.getFieldValue("to_latitude").valueOf()],country:e.getFieldValue("to_country").valueOf(),pctx:n&&n.valueOf()},timestamp:e.getFieldValue("timestamp").valueOf(),type:i&&i.valueOf()}})},deleteRecords:function(){var e=this._createTransaction();const t=this._records.splice(0,this._records.length).map(function(e){return{collection_id:c,record_id:e.getRecordId()}});return e.deleteRecords(t),this._pushTransaction(e)},addRecord:function(e){var t=this._createTransaction(),n=this._records.find(function(t){return t.getFieldValue("from_title").valueOf()===e.from.title&&t.getFieldValue("to_title").valueOf()===e.to.title&&r.areSameCoordinates(t.getFieldValue("from_longitude").valueOf(),e.from.coordinates[0])&&r.areSameCoordinates(t.getFieldValue("from_latitude").valueOf(),e.from.coordinates[1])&&r.areSameCoordinates(t.getFieldValue("to_longitude").valueOf(),e.to.coordinates[0])&&r.areSameCoordinates(t.getFieldValue("to_latitude").valueOf(),e.to.coordinates[1])});if(n)t.updateRecordFields({collection_id:c,record_id:n.getRecordId()},Object.assign({},{timestamp:this._getTimestampField()},this._getPctxFields(e)));else{if(this._records.length>=u){var i=this._records.splice(u-1).map(function(e){return{collection_id:c,record_id:e.getRecordId()}});t.deleteRecords(i)}t.insertRecords({collection_id:c,record_id:o.v4(),fields:this._getFields(e)})}return this._pushTransaction(t)},_getFields:function(e){var t={from_title:{type:"string",value:e.from.title},from_description:{type:"string",value:e.from.description},from_longitude:{type:"double",value:e.from.coordinates[0]},from_latitude:{type:"double",value:e.from.coordinates[1]},from_country:{type:"string",value:e.from.country},to_title:{type:"string",value:e.to.title},to_description:{type:"string",value:e.to.description},to_longitude:{type:"double",value:e.to.coordinates[0]},to_latitude:{type:"double",value:e.to.coordinates[1]},to_country:{type:"string",value:e.to.country},timestamp:this._getTimestampField()};return e.type&&(t.ride_type={type:"string",value:e.type}),Object.assign({},t,this._getPctxFields(e))},_getTimestampField:function(){return{type:"datetime",value:(new Date).toISOString()}},_getPctxFields:function(e){var t={};return e.from.pctx&&(t.from_point_context={type:"string",value:e.from.pctx}),e.to.pctx&&(t.to_point_context={type:"string",value:e.to.pctx}),t},_onDbUpdate:function(e){this._revision!==e&&(this._revision=e,this._readDb())},_readDb:function(){this._records=[],this._db.forEach(c,function(e){this._records.push(e)},this),this._records.sort(function(e,t){var n=new Date(e.getFieldValue("timestamp").valueOf()),i=new Date(t.getFieldValue("timestamp").valueOf());return n>i?-1:1})}},{getInstance:function(){return n.load().then(function(e){return e.openDatabase({database_id:a,background_sync:s.backgroundSync,context:"app"}).then(function(e){return new d(e)})})}});e(d)}),r.define("search-history-manager",["abstract-db-manager","data-sync-api","inherit","uuid","config"],function(e,t,n,i,r,o){var s=".ext.maps_common@ymapssearchhistory1",a="search_history",c=100,u=i(t,{__constructor:function(e){this.__base(e),this._readDb(),e.on("update",this._onDbUpdate.bind(this))},getRecords:function(){return this._records.map(function(e){var t=e.getFieldValue("uri");return{text:e.getFieldValue("display_text").valueOf(),uri:t&&t.valueOf()}})},deleteRecords:function(){var e=this._createTransaction();const t=this._records.splice(0,this._records.length).map(function(e){return{collection_id:a,record_id:e.getRecordId()}});return e.deleteRecords(t),this._pushTransaction(e)},addRecord:function(e){var t=this._createTransaction(),n=this._records.find(function(t){return t.getFieldValue("search_text").valueOf()===e.text&&(!e.uri||t.getFieldValue("uri").valueOf()===e.uri)});if(n)t.updateRecordFields({collection_id:a,record_id:n.getRecordId()},{last_used:{type:"datetime",value:(new Date).toISOString()}});else{if(this._records.length>=c){var i=this._records.splice(0,this._records.length-c+1).map(function(e){return{collection_id:a,record_id:e.getRecordId()}});t.deleteRecords(i)}t.insertRecords({collection_id:a,record_id:r.v4(),fields:this._convertParamsToRecordFields(e)})}return this._pushTransaction(t)},_convertParamsToRecordFields:function(e){var t={search_text:{type:"string",value:e.text},display_text:{type:"string",value:e.text},last_used:{type:"datetime",value:(new Date).toISOString()}};return e.uri&&(t.uri={type:"string",value:e.uri}),t},_onDbUpdate:function(e){this._revision!==e&&(this._revision=e,this._readDb())},_readDb:function(){this._records=[],this._db.forEach(a,function(e){this._records.push(e)},this),this._records.sort(function(e,t){var n=new Date(e.getFieldValue("last_used").valueOf()),i=new Date(t.getFieldValue("last_used").valueOf());return n>i?1:-1})}},{getInstance:function(){return n.load().then(function(e){return e.openDatabase({database_id:s,background_sync:o.backgroundSync,context:"app"}).then(function(e){return new u(e)})})}});e(u)}),r.define("trucks-manager",["abstract-db-manager","data-sync-api","inherit","uuid","assert","config"],function(e,t,n,i,r,o,s){function a(e){const t=e.getFields(),n=Object.keys(t).reduce(function(t,n){return e.getFieldValue(n)&&(t[n]=e.getFieldValue(n).valueOf()),t},{});return n.id=e.getRecordId(),n}function c(e){return Object.keys(e).reduce(function(t,n){if("id"===n)return t;var i=_[n];return i?t[n]={type:_[n],value:e[n]}:t[n]=e[n],t},{})}var u=".ext.maps_common@geomobilesettings1",d="geomobiletruckscollection",l="geomobilesettings",f="truck_id",h=i(t,{__constructor:function(e){this.__base(e),this._db.on("update",this._onDbUpdate.bind(this)),this._updateData()},getAllTrucks:function(){return this._trucks},addTruck:function(e){var t=this._createTransaction(),n=c(e);return t.insertRecords({collection_id:d,record_id:e.id,fields:n}),this._pushTransaction(t)},editTruck:function(e){var t=this._createTransaction(),n=c(e);return t.updateRecordFields({collection_id:d,record_id:e.id},n),this._pushTransaction(t)},getTruckActiveId:function(){const e=this._settings.find(function(e){return e.getRecordId()===f});return e&&e.getFieldValue("value")?e.getFieldValue("value").valueOf():null},setTruckActiveId:function(e){var t=this._createTransaction();const n=this._settings.find(function(e){return e.getRecordId()===f})||null;return null===n?t.insertRecords({collection_id:l,record_id:f,fields:{type:"string",value:e}}):t.updateRecordFields({collection_id:l,record_id:f},{type:"string",value:e}),this._pushTransaction(t)},removeTruck:function(e){this._assertTruck(e.id);var t=this._createTransaction();return t.deleteRecords({collection_id:d,record_id:e.id}),this._pushTransaction(t)},_updateData:function(){this._trucks=[],this._settings=[],this._db.forEach(d,function(e){this._trucks.push(a(e))},this),this._db.forEach(l,function(e){this._settings.push(e)},this)},_onDbUpdate:function(e){this._revision!==e&&(this._revision=e,this._updateData(),this.emit("trucks-update"))},_assertTruck:function(e){o(this._trucks.find(function(t){return t.id===e}),"There is no truck with record-id `%s`",e)}},{_instancePromise:null,getInstance:function(){return this._instancePromise||(this._instancePromise=n.load().then(function(e){return e.openDatabase({database_id:u,background_sync:s.backgroundSync,context:"app"}).then(function(e){return new h(e)},function(e){throw e})})),this._instancePromise}}),_={weight:"double",max_weight:"double",payload:"double",height:"double",width:"double",length:"double",axles:"integer",has_trailer:"boolean",axle_weight:"double",busway_permitted:"boolean"};e(h)}),r.define("geo-utils",function(e){var t=1e-6,n={areSameCoordinates:function(e,n){return Math.abs(Number(e)-Number(n))<t}};e(n)}),r.define("data-sync-api-operation",["data-sync-api"],function(e,t){t.load().done(function(){ya.modules.require("cloud.dataSyncApi.Operation",function(t){e(t)})})}),r.define("data-sync-api-record",["data-sync-api"],function(e,t){t.load().done(function(){ya.modules.require("cloud.dataSyncApi.Record",function(t){e(t)})})}),r.define("data-sync-api-value",["data-sync-api"],function(e,t){t.load().done(function(){ya.modules.require("cloud.dataSyncApi.Value",function(t){e(t)})})}),r.define("data-sync-api",["vow","config"],function(e,t,n){var i;e({load:function(){return i||(i=t.defer(),ya.modules.require("cloud.dataSyncApi.config",function(e){e.apiHost=n.cloudApiUrl,ya.cloud.client.isInitialized()?i.resolve(ya.cloud.dataSyncApi):ya.cloud.client.initialize({with_credentials:!0}).then(function(){i.resolve(ya.cloud.dataSyncApi)},function(e){i.reject(e)})})),i.promise()}})}),r.define("data-sync-apply-list-delta",["assert"],function(e,t){function n(e,n){switch(e.operation){case"create":n.length=0,n[0]=e.value;break;case"set_item":t(e.position<n.length,"Set index is greather than list size"),n[e.position]=e.value;break;case"insert_item":t(e.position<=n.length,"Insert index is greather than list size"),n.splice(e.position,0,e.value);break;case"delete_item":t(e.position<n.length,"Delete index is greather than list size"),n.splice(e.position,1);break;case"move_item":t(e.position<n.length,"Move index is greather than list size"),t(e.newPosition<n.length,"Move new index is greather than list size"),e.position<e.newPosition?(n.splice(e.newPosition+1,0,n[e.position]),n.splice(e.position,1)):e.position>e.newPosition&&(n.splice(e.newPosition,0,n[e.position]),n.splice(e.position+1,1));break;default:t(!1,"Unknown list operation: %s",e.operation)}}e(n)}),r.define("data-sync-delta-parser",["data-sync-delta","data-sync-field-delta","assert"],function(e,t,n,i){function r(e,t){e.forEach(function(e){var n=e.getType();i(s[n],"Unkown operation type: %s",n),t.applyRecordDelta(e.getCollectionId(),e.getRecordId(),n),e.getFieldOperations().forEach(function(n){t.applyFieldDelta(e.getCollectionId(),e.getRecordId(),n.getFieldId(),o(n))})})}function o(e){var t=new n;switch(e.getType()){case"delete":t.operation="delete";break;case"set":var r=e.getValue();"list"===r.getType()?(t.operation="list_change",t.putListDelta({operation:"create",value:r})):(t.operation="set",t.value=r);break;case"list_item_insert":t.operation="list_change",t.putListDelta({operation:"insert_item",value:e.getValue(),position:e.getIndex()});break;case"list_item_set":t.operation="list_change",t.putListDelta({operation:"set_item",value:e.getValue(),position:e.getIndex()});break;case"list_item_delete":t.operation="list_change",t.putListDelta({operation:"delete_item",position:e.getIndex()});break;case"list_item_move":t.operation="list_change",t.putListDelta({operation:"move_item",position:e.getIndex(),newPosition:e.getNewIndex()});break;default:i(!1,"Unkown field operation type: %s",e.getType())}return t}var s={insert:!0,update:!0,set:!0,"delete":!0};e({parseRevisionHistory:function(e){var n=new t;return e.forEach(function(e){r(e.operations,n)}),n},parseOperations:function(e){var n=new t;return r(e,n),n}})}),r.define("data-sync-delta-serializer",function(e){function t(e,t,n){switch(t.operation){case"set":n.push({field_id:e,type:"set",value:t.value});break;case"delete":n.push({field_id:e,type:"delete"});break;case"list_change":t.listDeltas.forEach(function(t){switch(t.operation){case"create":n.push({field_id:e,type:"set",value:t.value});break;case"set_item":n.push({field_id:e,type:"list_item_set",index:t.position,value:t.value});break;case"insert_item":n.push({field_id:e,type:"list_item_insert",index:t.position,value:t.value});break;case"delete_item":n.push({field_id:e,type:"list_item_delete",index:t.position});break;case"move_item":n.push({field_id:e,type:"list_item_move",index:t.position,new_index:t.newPosition})}})}}e({toOperations:function(e){var n=[];return e.getCollectionIds().forEach(function(i){e.getRecordIds(i).forEach(function(r){var o=[];e.getFieldIds(i,r).forEach(function(n){var s=e.getFieldDelta(i,r,n);t(n,s,o)}),n.push({collection_id:i,record_id:r,type:e.getRecordDelta(i,r),field_operations:o})})}),n}})}),r.define("data-sync-delta",["inherit","assert","data-sync-field-delta"],function(e,t,n,i){function r(e){n(!1,"Unknown operation: %s",e)}var o=t({__constructor:function(){this._changes={}},isEmpty:function(){return 0===Object.keys(this._changes).length},hasCollection:function(e){return void 0!==this._changes[e]},getCollectionIds:function(){return Object.keys(this._changes)},getRecordIds:function(e){return Object.keys(this._changes[e])},getFieldIds:function(e,t){return Object.keys(this._changes[e][t].fieldDeltas)},getRecordDelta:function(e,t){var n=this._getRecordData(e,t);if(n)return n.recordDelta},getFieldDelta:function(e,t,n){var i=this._getRecordData(e,t);if(i)return i.fieldDeltas[n]},applyRecordDelta:function(e,t,n){var i=this.getRecordDelta(e,t);if(!i)return void this._setRecordDelta(e,t,n);switch(i){case"insert":switch(n){case"delete":this._deleteRecordDelta(e,t);break;case"insert":case"update":case"set":break;default:r(n)}break;case"delete":switch(n){case"insert":this._setRecordDelta(e,t,"set");break;case"delete":case"update":case"set":break;default:r(n)}break;case"update":switch(n){case"delete":case"set":this._setRecordDelta(e,t,n);break;case"insert":case"update":break;default:r(n)}break;case"set":switch(n){case"delete":this._setRecordDelta(e,t,n);break;case"insert":case"update":case"set":break;default:r(n)}break;default:r(i)}},applyFieldDelta:function(e,t,n,o){switch(o.operation){case"set":case"delete":this.applyRecordDelta(e,t,"update"),this._setFieldDelta(e,t,n,o);break;case"list_change":if(o.listDeltas.length>0){this.applyRecordDelta(e,t,"update");var s,a=this.getFieldDelta(e,t,n);a&&"list_change"===a.operation?s=a:(s=new i("list_change"),this._setFieldDelta(e,t,n,s)),o.listDeltas.forEach(function(e){s.putListDelta(e)})}break;default:r(o.operation)}},_getRecordData:function(e,t){var n=this._changes[e];if(n)return n[t]},_setRecordDelta:function(e,t,n){var i=this._changes[e];i||(i=this._changes[e]={}),i[t]={recordDelta:n,fieldDeltas:{}}},_deleteRecordDelta:function(e,t){var n=this._changes[e];delete n[t],Object.keys(n).length||delete this._changes[e]},_setFieldDelta:function(e,t,n,i){this._changes[e][t].fieldDeltas[n]=i}});e(o)}),r.define("data-sync-field-delta",["inherit","assert","data-sync-apply-list-delta"],function(e,t,n,i){var r=t({__constructor:function(e,t){this.operation=e,this.value=t,this.listDeltas=[]},putListDelta:function(e){n("list_change"===this.operation,"Field operation isn't list change"),"create"===e.operation&&(this.listDeltas=[]),this.listDeltas.length>0&&"create"===this.listDeltas[0].operation?i(e,this.listDeltas[0].value.valueOf()):this.listDeltas.push(e)}});e(r)}),r.define("data-sync-list-operation",["inherit","assert"],function(e,t,n){var i=t({transformed:function(e){e.dispatchTransformedNone(this)},toListDelta:function(){return null},dispatchTransformedNone:function(){return this},dispatchTransformedSet:function(){return this},dispatchTransformedInsert:function(){return this},dispatchTransformedDelete:function(){return this},dispatchTransformedMove:function(){return this}}),r=t({__constructor:function(e,t){this._position=e,this._isWin=t},getPosition:function(){return this._position},isWin:function(){return this._isWin}}),o=t(r,{__constructor:function(e,t,n){this.__base(e,n),this._value=t},transformed:function(e){return e.dispatchTransformedSet(this)},toListDelta:function(){return{operation:"set_item",position:this._position,value:this._value}},dispatchTransformedNone:function(){return this},dispatchTransformedSet:function(e){return this._position!==e.getPosition()||this._isWin?this:new i},dispatchTransformedInsert:function(e){return this._position>=e.getPosition()?new o(this._position+1,this._value,this._isWin):this},dispatchTransformedDelete:function(e){return this._position===e.getPosition()?new i:this._position>e.getPosition()?new o(this._position-1,this._value,this._isWin):this},dispatchTransformedMove:function(e){return this._position===e.getPosition()?new o(e.getNewPosition(),this._value,this._isWin):new o(e.transformPosition(this._position),this._value,this._isWin)}}),s=t(r,{__constructor:function(e,t,n){this.__base(e,n),this._value=t},transformed:function(e){return e.dispatchTransformedInsert(this)},toListDelta:function(){return{operation:"insert_item",position:this._position,value:this._value}},dispatchTransformedNone:function(){return this},dispatchTransformedSet:function(){return this},dispatchTransformedInsert:function(e){return this._position>e.getPosition()||this._position===e.getPosition()&&!this._isWin?new s(this._position+1,this._value,this._isWin):this},dispatchTransformedDelete:function(e){return this._position>e.getPosition()?new s(this._position-1,this._value,this._isWin):this},dispatchTransformedMove:function(e){return e.isForward()&&this._position>e.getPosition()&&this._position<=e.getNewPosition()?new s(this._position-1,this._value,this._isWin):e.isReversed()&&this._position<=e.getPosition()&&this._position>e.getNewPosition()?new s(this._position+1,this._value,this._isWin):this}}),a=t(r,{transformed:function(e){return e.dispatchTransformedDelete(this)},toListDelta:function(){return{operation:"delete_item",position:this._position}},dispatchTransformedNone:function(){return this},dispatchTransformedSet:function(){return this},dispatchTransformedInsert:function(e){return this._position>=e.getPosition()?new a(this._position+1,this._isWin):this;
},dispatchTransformedDelete:function(e){return this._position===e.getPosition()?new i:this._position>e.getPosition()?new a(this._position-1,this._isWin):this},dispatchTransformedMove:function(e){return this._position===e.getPosition()?new a(e.getNewPosition(),this._isWin):new a(e.transformPosition(this._position),this._isWin)}}),c=t(r,{__constructor:function(e,t,n){this.__base(e,n),this._newPosition=t},transformed:function(e){return e.dispatchTransformedMove(this)},toListDelta:function(){return{operation:"move_item",position:this._position,newPosition:this._newPosition}},dispatchTransformedNone:function(){return this},dispatchTransformedSet:function(){return this},dispatchTransformedInsert:function(e){var t=e.getPosition();return this.isForward()?t<=this._position?new c(this._position+1,this._newPosition+1,this._isWin):t<=this._newPosition?new c(this._position,this._newPosition+1,this._isWin):this:t<=this._newPosition?new c(this._position+1,this._newPosition+1,this._isWin):t<=this._position?new c(this._position+1,this._newPosition,this._isWin):this},dispatchTransformedDelete:function(e){var t=e.getPosition();return this._position===t?new i:this.isForward()?t<this._position?new c(this._position-1,this._newPosition-1,this._isWin):t<=this._newPosition?new c(this._position,this._newPosition-1,this._isWin):this:t<this._newPosition?new c(this._position-1,this._newPosition-1,this._isWin):t<this._position?new c(this._position-1,this._newPosition,this._isWin):this},dispatchTransformedMove:function(e){if(this._position===e.getPosition())return e.isWin()?new i:new c(e.getNewPosition(),this._newPosition,this._isWin);if(this._position===this._newPosition)return new i;var t=this.isForward()&&e.isForward()||this.isReversed()&&e.isReversed();return this._newPosition===e.getNewPosition()?t&&!e.isWin()?new c(e.transformPosition(this._position),this._newPosition,this._isWin):new c(e.transformPosition(this._position),e.transformPosition(this._newPosition),this._isWin):this._newPosition===e.getPosition()?t?new c(e.transformPosition(this._position),e.transformPosition(this._newPosition),this._isWin):new c(e.transformPosition(this._position),this._newPosition,this._isWin):this._position===e.getNewPosition()&&t?new c(e.transformPosition(this._position),this._newPosition,this._isWin):new c(e.transformPosition(this._position),e.transformPosition(this._newPosition),this._isWin)},transformPosition:function(e){return this._position<this._newPosition&&e>=this._position&&e<=this._newPosition?e-1:this._position>this._newPosition&&e<=this._position&&e>=this._newPosition?e+1:e},isForward:function(){return this._position<=this._newPosition},isReversed:function(){return this._position>this._newPosition},getNewPosition:function(){return this._newPosition}});e({create:function(e,t){switch(n("create"!==e.operation),e.operation){case"set_item":return new o(e.position,e.value,t);case"insert_item":return new s(e.position,e.value,t);case"delete_item":return new a(e.position,t);case"move_item":return new c(e.position,e.newPosition,t);default:n(!1,"Unkown list operation: %s",e.operation)}}})}),r.define("data-sync-rebase",["data-sync-delta","data-sync-field-delta","data-sync-list-operation","assert"],function(e,t,n,i,r){function o(e,n){var i=new t;return e.getCollectionIds().forEach(function(t){n.hasCollection(t)?s(t,e,n,i):f(t,e,i)}),i}function s(e,t,n,i){t.getRecordIds(e).forEach(function(r){n.getRecordDelta(e,r)?a(e,r,t,n,i):l(e,r,t,i)})}function a(e,t,n,i,r){var o=i.getRecordDelta(e,t),s=n.getRecordDelta(e,t);if(("set"!==o||"set"===s)&&("set"!==o&&"set"===s&&l(e,t,n,r),"delete"!==o))return"delete"===s?void r.applyRecordDelta(e,t,s):void n.getFieldIds(e,t).forEach(function(o){var s=n.getFieldDelta(e,t,o),a=i.getFieldDelta(e,t,o);if(a){var u=c(s,a);u&&r.applyFieldDelta(e,t,o,u)}else r.applyFieldDelta(e,t,o,s)})}function c(e,t){if("delete"!==t.operation)return"delete"===e.operation?e:"list_change"===e.operation&&"list_change"===t.operation?u(e,t):void 0}function u(e,t){var i=e.listDeltas,o=t.listDeltas;r(i.length>0),r(o.length>0);var s="create"===i[0].operation,a="create"===o[0].operation;if(!a||s){if(!a&&s)return e;var c=new n("list_change");if(a&&s){var u=i[0].value.valueOf(),l=o[0].value.valueOf();u.forEach(function(e,t){c.putListDelta({operation:"insert_item",value:e,position:l.length+t})})}else{var f=d(o,!0),h=d(i,!1);f.forEach(function(e,t){h.forEach(function(n,i){f[t]=n.transformed(e),h[i]=e.transformed(n)})}),h.forEach(function(e){var t=e.toListDelta();t&&c.putListDelta(t)})}return c}}function d(e,t){return e.map(function(e){return i.create(e,t)})}function l(e,t,n,i){var r=n.getRecordDelta(e,t);i.applyRecordDelta(e,t,r),n.getFieldIds(e,t).forEach(function(r){var o=n.getFieldDelta(e,t,r);i.applyFieldDelta(e,t,r,o)})}function f(e,t,n){t.getRecordIds(e).forEach(function(i){l(e,i,t,n)})}e(o)}),r.define("event-emitter",["inherit"],function(e,t){var n=Array.prototype.slice,i=t({on:function(e,t,n){if("function"!=typeof t)throw new Error("EventEmitter#on(): `callback` must be a function.");this._events||(this._events={});var i={callback:t,context:n},r=this._events[e];return r?r.push(i):(this._events[e]=[i],this._onAddEvent(e)),this},once:function(e,t,n){function i(){r.off(e,i,n),t.apply(n,arguments)}if("function"!=typeof t)throw new Error("EventEmitter#once(): `callback` must be a function.");var r=this;return i._callback=t,this.on(e,i,n),this},off:function(e,t,n){if("function"!=typeof t)throw new Error("EventEmitter#off(): `callback` must be a function.");if(!this._events)return this;var i=this._events[e];if(!i)return this;for(var r=i.length,o=0;o<r;o++){var s=i[o],a=s.callback;if((a===t||a._callback===t)&&s.context===n){1===r?(delete this._events[e],this._onRemoveEvent(e)):i.splice(o,1);break}}return this},offAll:function(e){if(this._events)if(e)this._events[e]&&(delete this._events[e],this._onRemoveEvent(e));else{for(e in this._events)this._events.hasOwnProperty(e)&&this._onRemoveEvent(e);delete this._events}return this},emit:function(e){if(!this._events)return this;var t=this._events[e];if(!t)return this;var i,r=t.slice(0),o=r.length,s=-1;switch(arguments.length){case 1:for(;++s<o;)i=r[s],i.callback.call(i.context);break;case 2:for(;++s<o;)i=r[s],i.callback.call(i.context,arguments[1]);break;case 3:for(;++s<o;)i=r[s],i.callback.call(i.context,arguments[1],arguments[2]);break;default:for(var a=n.call(arguments,1);++s<o;)i=r[s],i.callback.apply(i.context,a)}return this},_onAddEvent:function(){},_onRemoveEvent:function(){}});e(i)}),r.define("assert",function(e){var t=function(e,t){if(t||(t=""),!e){var n=arguments,i=2,r=new Error("Assertion failed: "+t.replace(/%s/g,function(){return n[i++]}));throw r}};e(t)}),r.define("uuid",function(e){e(uuid.noConflict())}),r.define("data-sync-api-db-mock",["inherit","event-emitter","data-sync-api-record"],function(e,t,n,i){var r=t(n,{__constructor:function(){this.__base(),this._dataset={}},getRecord:function(e,t){var n=this._dataset[e];if(n)return n[t]},forEach:function(e,t,n){return"string"!=typeof e&&(n=t,t=e,e=null),e?this._iterateCollectionRecords(e,t,n):Object.keys(this._dataset).forEach(function(e){this._iterateCollectionRecords(e,t,n)},this),this},createTransaction:function(){},update:function(){},getRevision:function(){return 0},addRecords:function(e){[].concat(e).forEach(function(e){this._dataset[e.collection_id]||(this._dataset[e.collection_id]={}),this._dataset[e.collection_id][e.record_id]=new i(e)},this)},_iterateCollectionRecords:function(e,t,n){var i=this._dataset[e];i&&Object.keys(i).forEach(function(e){t.call(n,i[e])})}});e(r)}),r.define("data-sync-api-transaction-mock",["inherit","data-sync-api-operation","data-sync-api-record"],function(e,t,n,i){var r=t({__constructor:function(){this._operations=[]},addOperations:function(e){return[].concat(e).forEach(function(e){this._operations.push(e instanceof n?e:new n(e))},this),this},getOperations:function(){return this._operations},deleteRecords:function(e){var t=[].concat(e).map(function(e){return e=this._castRecord(e),{collection_id:e.getCollectionId(),record_id:e.getRecordId(),type:"delete"}},this);return this.addOperations(t)},insertRecords:function(e){var t=[].concat(e).map(function(e){e=this._castRecord(e);var t=e.getFieldIds().map(function(t){return{field_id:t,type:"set",value:e.getFieldValue(t)}});return{collection_id:e.getCollectionId(),record_id:e.getRecordId(),type:"insert",field_operations:t}},this);return this.addOperations(t)},insertRecordFieldListItem:function(e,t){return e=this._castRecord(e),this.addOperations({collection_id:e.getCollectionId(),record_id:e.getRecordId(),type:"update",field_operations:[{field_id:t.field_id,type:"list_item_insert",index:t.index,value:t.value}]})},deleteRecordFieldListItem:function(e,t){return e=this._castRecord(e),this.addOperations({collection_id:e.getCollectionId(),record_id:e.getRecordId(),type:"update",field_operations:[{field_id:t.field_id,type:"list_item_delete",index:t.index}]})},setRecordFieldListItem:function(e,t){return e=this._castRecord(e),this.addOperations({collection_id:e.getCollectionId(),record_id:e.getRecordId(),type:"update",field_operations:[{field_id:t.field_id,type:"list_item_set",index:t.index}]})},moveRecordFieldListItem:function(e,t){return e=this._castRecord(e),this.addOperations({collection_id:e.getCollectionId(),record_id:e.getRecordId(),type:"update",field_operations:[{field_id:t.field_id,type:"list_item_move",index:t.index,new_index:t.new_index}]})},push:function(){},_castRecord:function(e){return e instanceof i?e:new i(e)}});e(r)})}();var i=!0;"object"==typeof module&&"object"==typeof module.exports&&(module.exports=t,i=!1),"object"==typeof modules&&"function"==typeof modules.define&&(modules.define("yandex-maps-bookmarks",function(e){e(t)}),modules.define("abstract-db-manager",function(t){e.ya.modules.require("abstract-db-manager",function(e){t(e)})}),modules.define("data-sync-api",function(t){e.ya.modules.require("data-sync-api",function(e){t(e)})}),i=!1),"function"==typeof define&&(define(function(e,n,i){i.exports=t}),i=!1),i&&n("bookmarks",t),function(e){var t={cloud:{},vow:e.ya&&e.ya.vow||e.vow,modules:e.ya&&e.ya.modules||e.modules};t.modules.define("vow",function(e){e(t.vow)}),function(e){var t={exports:{}},n={},i=e.vow.Promise;!function(e,i){"object"==typeof n&&"object"==typeof t?t.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof n?n.localforage=i():e.localforage=i()}(this,function(){return function(e){function t(i){if(n[i])return n[i].exports;var r=n[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}t.__esModule=!0,function(){function e(e,t){e[t]=function(){var n=arguments;return e.ready().then(function(){return e[t].apply(e,n)})}}function o(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var n in t)t.hasOwnProperty(n)&&(h(t[n])?arguments[0][n]=t[n].slice():arguments[0][n]=t[n])}return arguments[0]}function s(e){for(var t in c)if(c.hasOwnProperty(t)&&c[t]===e)return!0;return!1}var a={},c={INDEXEDDB:"asyncStorage",LOCALSTORAGE:"localStorageWrapper",WEBSQL:"webSQLStorage"},u=[c.INDEXEDDB,c.WEBSQL,c.LOCALSTORAGE],d=["clear","getItem","iterate","key","keys","length","removeItem","setItem"],l={description:"",driver:u.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1},f=function(e){var t=t||e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.OIndexedDB||e.msIndexedDB,n={};return n[c.WEBSQL]=!!e.openDatabase,n[c.INDEXEDDB]=!!function(){if("undefined"!=typeof e.openDatabase&&e.navigator&&e.navigator.userAgent&&/Safari/.test(e.navigator.userAgent)&&!/Chrome/.test(e.navigator.userAgent))return!1;try{return t&&"function"==typeof t.open&&"undefined"!=typeof e.IDBKeyRange}catch(n){return!1}}(),n[c.LOCALSTORAGE]=!!function(){try{return e.localStorage&&"setItem"in e.localStorage&&e.localStorage.setItem}catch(t){return!1}}(),n}(this),h=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},_=function(){function t(e){r(this,t),this.INDEXEDDB=c.INDEXEDDB,this.LOCALSTORAGE=c.LOCALSTORAGE,this.WEBSQL=c.WEBSQL,this._defaultConfig=o({},l),this._config=o({},this._defaultConfig,e),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver)}return t.prototype.config=function(e){if("object"==typeof e){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e)"storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),this._config[t]=e[t];return"driver"in e&&e.driver&&this.setDriver(this._config.driver),!0}return"string"==typeof e?this._config[e]:this._config},t.prototype.defineDriver=function(e,t,n){var r=new i(function(t,n){try{var r=e._driver,o=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver"),c=new Error("Custom driver name already in use: "+e._driver);if(!e._driver)return void n(o);if(s(e._driver))return void n(c);for(var u=d.concat("_initStorage"),l=0;l<u.length;l++){var h=u[l];if(!h||!e[h]||"function"!=typeof e[h])return void n(o)}var _=i.resolve(!0);"_support"in e&&(_=e._support&&"function"==typeof e._support?e._support():i.resolve(!!e._support)),_.then(function(n){f[r]=n,a[r]=e,t()},n)}catch(p){n(p)}});return r.then(t,n),r},t.prototype.driver=function(){return this._driver||null},t.prototype.getDriver=function(e,t,r){var o=this,c=function(){if(s(e))switch(e){case o.INDEXEDDB:return new i(function(e,t){e(n(1))});case o.LOCALSTORAGE:return new i(function(e,t){e(n(2))});case o.WEBSQL:return new i(function(e,t){e(n(4))})}else if(a[e])return i.resolve(a[e]);return i.reject(new Error("Driver not found."))}();return c.then(t,r),c},t.prototype.getSerializer=function(e){var t=new i(function(e,t){e(n(3))});return e&&"function"==typeof e&&t.then(function(t){e(t)}),t},t.prototype.ready=function(e){var t=this,n=t._driverSet.then(function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready});return n.then(e,e),n},t.prototype.setDriver=function(e,t,n){function r(){s._config.driver=s.driver()}function o(e){return function(){function t(){for(;n<e.length;){var o=e[n];return n++,s._dbInfo=null,s._ready=null,s.getDriver(o).then(function(e){return s._extend(e),r(),s._ready=s._initStorage(s._config),s._ready})["catch"](t)}r();var a=new Error("No available storage method found.");return s._driverSet=i.reject(a),s._driverSet}var n=0;return t()}}var s=this;h(e)||(e=[e]);var a=this._getSupportedDrivers(e),c=null!==this._driverSet?this._driverSet["catch"](function(){return i.resolve()}):i.resolve();return this._driverSet=c.then(function(){var e=a[0];return s._dbInfo=null,s._ready=null,s.getDriver(e).then(function(e){s._driver=e._driver,r(),s._wrapLibraryMethodsWithReady(),s._initDriver=o(a)})})["catch"](function(){r();var e=new Error("No available storage method found.");return s._driverSet=i.reject(e),s._driverSet}),this._driverSet.then(t,n),this._driverSet},t.prototype.supports=function(e){return!!f[e]},t.prototype._extend=function(e){o(this,e)},t.prototype._getSupportedDrivers=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var r=e[n];this.supports(r)&&t.push(r)}return t},t.prototype._wrapLibraryMethodsWithReady=function(){for(var t=0;t<d.length;t++)e(this,d[t])},t.prototype.createInstance=function(e){return new t(e)},t}(),p=new _;t["default"]=p}.call("undefined"!=typeof window?window:self),e.exports=t["default"]},function(e,t){"use strict";t.__esModule=!0,function(){function e(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(n){if("TypeError"!==n.name)throw n;for(var i=O.BlobBuilder||O.MSBlobBuilder||O.MozBlobBuilder||O.WebKitBlobBuilder,r=new i,o=0;o<e.length;o+=1)r.append(e[o]);return r.getBlob(t.type)}}function n(e){for(var t=e.length,n=new ArrayBuffer(t),i=new Uint8Array(n),r=0;r<t;r++)i[r]=e.charCodeAt(r);return n}function r(e){return new i(function(t,n){var i=new XMLHttpRequest;i.open("GET",e),i.withCredentials=!0,i.responseType="arraybuffer",i.onreadystatechange=function(){if(4===i.readyState)return 200===i.status?t({response:i.response,type:i.getResponseHeader("Content-Type")}):void n({status:i.status,response:i.response})},i.send()})}function o(t){return new i(function(n,i){var o=e([""],{type:"image/png"}),s=t.transaction([T],"readwrite");s.objectStore(T).put(o,"key"),s.oncomplete=function(){var e=t.transaction([T],"readwrite"),o=e.objectStore(T).get("key");o.onerror=i,o.onsuccess=function(e){var t=e.target.result,i=URL.createObjectURL(t);r(i).then(function(e){n(!(!e||"image/png"!==e.type))},function(){n(!1)}).then(function(){URL.revokeObjectURL(i)})}}})["catch"](function(){return!1})}function s(e){return"boolean"==typeof k?i.resolve(k):o(e).then(function(e){return k=e})}function a(e){return new i(function(t,n){var i=new FileReader;i.onerror=n,i.onloadend=function(n){var i=btoa(n.target.result||"");t({__local_forage_encoded_blob:!0,data:i,type:e.type})},i.readAsBinaryString(e)})}function c(t){var i=n(atob(t.data));return e([i],{type:t.type})}function u(e){return e&&e.__local_forage_encoded_blob}function d(e){function t(){return i.resolve()}var n=this,r={db:null};if(e)for(var o in e)r[o]=e[o];E||(E={});var s=E[r.name];s||(s={forages:[],db:null},E[r.name]=s),s.forages.push(this);for(var a=[],c=0;c<s.forages.length;c++){var u=s.forages[c];u!==this&&a.push(u.ready()["catch"](t))}var d=s.forages.slice(0);return i.all(a).then(function(){return r.db=s.db,l(r)}).then(function(e){return r.db=e,_(r,n._defaultConfig.version)?f(r):e}).then(function(e){r.db=s.db=e,n._dbInfo=r;for(var t in d){var i=d[t];i!==n&&(i._dbInfo.db=r.db,i._dbInfo.version=r.version)}})}function l(e){return h(e,!1)}function f(e){return h(e,!0)}function h(e,t){return new i(function(n,i){if(e.db){if(!t)return n(e.db);e.db.close()}var r=[e.name];t&&r.push(e.version);var o=R.open.apply(R,r);t&&(o.onupgradeneeded=function(t){var n=o.result;try{n.createObjectStore(e.storeName),t.oldVersion<=1&&n.createObjectStore(T)}catch(i){if("ConstraintError"!==i.name)throw i;O.console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),o.onerror=function(){i(o.error)},o.onsuccess=function(){n(o.result)}})}function _(e,t){if(!e.db)return!0;var n=!e.db.objectStoreNames.contains(e.storeName),i=e.version<e.db.version,r=e.version>e.db.version;if(i&&(e.version!==t&&O.console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),r||n){if(n){var o=e.db.version+1;o>e.version&&(e.version=o)}return!0}return!1}function p(e,t){var n=this;"string"!=typeof e&&(O.console.warn(e+" used as a key, but it is not a string."),e=String(e));var r=new i(function(t,i){n.ready().then(function(){var r=n._dbInfo,o=r.db.transaction(r.storeName,"readonly").objectStore(r.storeName),s=o.get(e);s.onsuccess=function(){var e=s.result;void 0===e&&(e=null),u(e)&&(e=c(e)),t(e)},s.onerror=function(){i(s.error)}})["catch"](i)});return D(r,t),r}function v(e,t){var n=this,r=new i(function(t,i){n.ready().then(function(){var r=n._dbInfo,o=r.db.transaction(r.storeName,"readonly").objectStore(r.storeName),s=o.openCursor(),a=1;s.onsuccess=function(){var n=s.result;if(n){var i=n.value;u(i)&&(i=c(i));var r=e(i,n.key,a++);void 0!==r?t(r):n["continue"]()}else t()},s.onerror=function(){i(s.error)}})["catch"](i)});return D(r,t),r}function g(e,t,n){var r=this;"string"!=typeof e&&(O.console.warn(e+" used as a key, but it is not a string."),e=String(e));var o=new i(function(n,i){var o;r.ready().then(function(){return o=r._dbInfo,s(o.db)}).then(function(e){return!e&&t instanceof Blob?a(t):t}).then(function(t){var r=o.db.transaction(o.storeName,"readwrite"),s=r.objectStore(o.storeName);null===t&&(t=void 0);var a=s.put(t,e);r.oncomplete=function(){void 0===t&&(t=null),n(t)},r.onabort=r.onerror=function(){var e=a.error?a.error:a.transaction.error;i(e)}})["catch"](i)});return D(o,n),o}function y(e,t){var n=this;"string"!=typeof e&&(O.console.warn(e+" used as a key, but it is not a string."),e=String(e));var r=new i(function(t,i){n.ready().then(function(){var r=n._dbInfo,o=r.db.transaction(r.storeName,"readwrite"),s=o.objectStore(r.storeName),a=s["delete"](e);o.oncomplete=function(){t()},o.onerror=function(){i(a.error)},o.onabort=function(){var e=a.error?a.error:a.transaction.error;i(e)}})["catch"](i)});return D(r,t),r}function m(e){var t=this,n=new i(function(e,n){t.ready().then(function(){var i=t._dbInfo,r=i.db.transaction(i.storeName,"readwrite"),o=r.objectStore(i.storeName),s=o.clear();r.oncomplete=function(){e()},r.onabort=r.onerror=function(){var e=s.error?s.error:s.transaction.error;n(e)}})["catch"](n)});return D(n,e),n}function b(e){var t=this,n=new i(function(e,n){t.ready().then(function(){var i=t._dbInfo,r=i.db.transaction(i.storeName,"readonly").objectStore(i.storeName),o=r.count();o.onsuccess=function(){e(o.result)},o.onerror=function(){n(o.error)}})["catch"](n)});return D(n,e),n}function w(e,t){var n=this,r=new i(function(t,i){return e<0?void t(null):void n.ready().then(function(){var r=n._dbInfo,o=r.db.transaction(r.storeName,"readonly").objectStore(r.storeName),s=!1,a=o.openCursor();a.onsuccess=function(){var n=a.result;return n?void(0===e?t(n.key):s?t(n.key):(s=!0,n.advance(e))):void t(null)},a.onerror=function(){i(a.error)}})["catch"](i)});return D(r,t),r}function I(e){var t=this,n=new i(function(e,n){t.ready().then(function(){var i=t._dbInfo,r=i.db.transaction(i.storeName,"readonly").objectStore(i.storeName),o=r.openCursor(),s=[];o.onsuccess=function(){var t=o.result;return t?(s.push(t.key),void t["continue"]()):void e(s)},o.onerror=function(){n(o.error)}})["catch"](n)});return D(n,e),n}function D(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}var O=this,R=R||this.indexedDB||this.webkitIndexedDB||this.mozIndexedDB||this.OIndexedDB||this.msIndexedDB;if(R){var k,E,T="local-forage-detect-blob-support",C={_driver:"asyncStorage",_initStorage:d,iterate:v,getItem:p,setItem:g,removeItem:y,clear:m,length:b,key:w,keys:I};t["default"]=C}}.call("undefined"!=typeof window?window:self),e.exports=t["default"]},function(e,t,n){"use strict";t.__esModule=!0,function(){function e(e){var t=this,r={};if(e)for(var o in e)r[o]=e[o];return r.keyPrefix=r.name+"/",r.storeName!==t._defaultConfig.storeName&&(r.keyPrefix+=r.storeName+"/"),t._dbInfo=r,new i(function(e,t){e(n(3))}).then(function(e){return r.serializer=e,i.resolve()})}function r(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo.keyPrefix,n=_.length-1;n>=0;n--){var i=_.key(n);0===i.indexOf(e)&&_.removeItem(i)}});return f(n,e),n}function o(e,t){var n=this;"string"!=typeof e&&(h.console.warn(e+" used as a key, but it is not a string."),e=String(e));var i=n.ready().then(function(){var t=n._dbInfo,i=_.getItem(t.keyPrefix+e);return i&&(i=t.serializer.deserialize(i)),i});return f(i,t),i}function s(e,t){var n=this,i=n.ready().then(function(){for(var t=n._dbInfo,i=t.keyPrefix,r=i.length,o=_.length,s=1,a=0;a<o;a++){var c=_.key(a);if(0===c.indexOf(i)){var u=_.getItem(c);if(u&&(u=t.serializer.deserialize(u)),u=e(u,c.substring(r),s++),void 0!==u)return u}}});return f(i,t),i}function a(e,t){var n=this,i=n.ready().then(function(){var t,i=n._dbInfo;try{t=_.key(e)}catch(r){t=null}return t&&(t=t.substring(i.keyPrefix.length)),t});return f(i,t),i}function c(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo,n=_.length,i=[],r=0;r<n;r++)0===_.key(r).indexOf(e.keyPrefix)&&i.push(_.key(r).substring(e.keyPrefix.length));return i});return f(n,e),n}function u(e){var t=this,n=t.keys().then(function(e){return e.length});return f(n,e),n}function d(e,t){var n=this;"string"!=typeof e&&(h.console.warn(e+" used as a key, but it is not a string."),e=String(e));var i=n.ready().then(function(){var t=n._dbInfo;_.removeItem(t.keyPrefix+e)});return f(i,t),i}function l(e,t,n){var r=this;"string"!=typeof e&&(h.console.warn(e+" used as a key, but it is not a string."),e=String(e));var o=r.ready().then(function(){void 0===t&&(t=null);var n=t;return new i(function(i,o){var s=r._dbInfo;s.serializer.serialize(t,function(t,r){if(r)o(r);else try{_.setItem(s.keyPrefix+e,t),i(n)}catch(a){"QuotaExceededError"!==a.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==a.name||o(a),o(a)}})})});return f(o,n),o}function f(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}var h=this,_=null;try{if(!(this.localStorage&&"setItem"in this.localStorage))return;_=this.localStorage}catch(p){return}var v={_driver:"localStorageWrapper",_initStorage:e,iterate:s,getItem:o,setItem:l,removeItem:d,clear:r,length:u,key:a,keys:c};t["default"]=v}.call("undefined"!=typeof window?window:self),e.exports=t["default"]},function(e,t){"use strict";t.__esModule=!0,function(){function e(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(n){if("TypeError"!==n.name)throw n;for(var i=D.BlobBuilder||D.MSBlobBuilder||D.MozBlobBuilder||D.WebKitBlobBuilder,r=new i,o=0;o<e.length;o+=1)r.append(e[o]);return r.getBlob(t.type)}}function n(e,t){var n="";if(e&&(n=e.toString()),e&&("[object ArrayBuffer]"===e.toString()||e.buffer&&"[object ArrayBuffer]"===e.buffer.toString())){var i,r=u;e instanceof ArrayBuffer?(i=e,r+=l):(i=e.buffer,"[object Int8Array]"===n?r+=h:"[object Uint8Array]"===n?r+=_:"[object Uint8ClampedArray]"===n?r+=p:"[object Int16Array]"===n?r+=v:"[object Uint16Array]"===n?r+=y:"[object Int32Array]"===n?r+=g:"[object Uint32Array]"===n?r+=m:"[object Float32Array]"===n?r+=b:"[object Float64Array]"===n?r+=w:t(new Error("Failed to get type for BinaryArray"))),t(r+o(i))}else if("[object Blob]"===n){var s=new FileReader;s.onload=function(){var n=a+e.type+"~"+o(this.result);t(u+f+n)},s.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(c){console.error("Couldn't convert value into a JSON string: ",e),t(null,c)}}function i(t){if(t.substring(0,d)!==u)return JSON.parse(t);var n,i=t.substring(I),o=t.substring(d,I);if(o===f&&c.test(i)){var s=i.match(c);n=s[1],i=i.substring(s[0].length)}var a=r(i);switch(o){case l:return a;case f:return e([a],{type:n});case h:return new Int8Array(a);case _:return new Uint8Array(a);case p:return new Uint8ClampedArray(a);case v:return new Int16Array(a);case y:return new Uint16Array(a);case g:return new Int32Array(a);case m:return new Uint32Array(a);case b:return new Float32Array(a);case w:return new Float64Array(a);default:throw new Error("Unkown type: "+o)}}function r(e){var t,n,i,r,o,a=.75*e.length,c=e.length,u=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var d=new ArrayBuffer(a),l=new Uint8Array(d);for(t=0;t<c;t+=4)n=s.indexOf(e[t]),i=s.indexOf(e[t+1]),r=s.indexOf(e[t+2]),o=s.indexOf(e[t+3]),l[u++]=n<<2|i>>4,l[u++]=(15&i)<<4|r>>2,l[u++]=(3&r)<<6|63&o;return d}function o(e){var t,n=new Uint8Array(e),i="";for(t=0;t<n.length;t+=3)i+=s[n[t]>>2],i+=s[(3&n[t])<<4|n[t+1]>>4],i+=s[(15&n[t+1])<<2|n[t+2]>>6],i+=s[63&n[t+2]];return n.length%3===2?i=i.substring(0,i.length-1)+"=":n.length%3===1&&(i=i.substring(0,i.length-2)+"=="),i}var s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a="~~local_forage_type~",c=/^~~local_forage_type~([^~]+)~/,u="__lfsc__:",d=u.length,l="arbf",f="blob",h="si08",_="ui08",p="uic8",v="si16",g="si32",y="ur16",m="ui32",b="fl32",w="fl64",I=d+l.length,D=this,O={serialize:n,deserialize:i,stringToBuffer:r,bufferToString:o};t["default"]=O}.call("undefined"!=typeof window?window:self),e.exports=t["default"]},function(e,t,n){"use strict";t.__esModule=!0,function(){function e(e){var t=this,r={db:null};if(e)for(var o in e)r[o]="string"!=typeof e[o]?e[o].toString():e[o];var s=new i(function(n,i){try{r.db=_(r.name,String(r.version),r.description,r.size)}catch(o){return t.setDriver(t.LOCALSTORAGE).then(function(){return t._initStorage(e)}).then(n)["catch"](i)}r.db.transaction(function(e){e.executeSql("CREATE TABLE IF NOT EXISTS "+r.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],function(){t._dbInfo=r,n()},function(e,t){i(t)})})});return new i(function(e,t){e(n(3))}).then(function(e){return r.serializer=e,s})}function r(e,t){var n=this;"string"!=typeof e&&(h.console.warn(e+" used as a key, but it is not a string."),e=String(e));var r=new i(function(t,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){n.executeSql("SELECT * FROM "+r.storeName+" WHERE key = ? LIMIT 1",[e],function(e,n){var i=n.rows.length?n.rows.item(0).value:null;i&&(i=r.serializer.deserialize(i)),t(i)},function(e,t){i(t)})})})["catch"](i)});return f(r,t),r}function o(e,t){var n=this,r=new i(function(t,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){n.executeSql("SELECT * FROM "+r.storeName,[],function(n,i){for(var o=i.rows,s=o.length,a=0;a<s;a++){var c=o.item(a),u=c.value;if(u&&(u=r.serializer.deserialize(u)),u=e(u,c.key,a+1),void 0!==u)return void t(u)}t()},function(e,t){i(t)})})})["catch"](i)});return f(r,t),r}function s(e,t,n){var r=this;"string"!=typeof e&&(h.console.warn(e+" used as a key, but it is not a string."),e=String(e));var o=new i(function(n,i){r.ready().then(function(){void 0===t&&(t=null);var o=t,s=r._dbInfo;s.serializer.serialize(t,function(t,r){r?i(r):s.db.transaction(function(r){r.executeSql("INSERT OR REPLACE INTO "+s.storeName+" (key, value) VALUES (?, ?)",[e,t],function(){n(o)},function(e,t){i(t)})},function(e){e.code===e.QUOTA_ERR&&i(e)})})})["catch"](i)});return f(o,n),o}function a(e,t){var n=this;"string"!=typeof e&&(h.console.warn(e+" used as a key, but it is not a string."),e=String(e));var r=new i(function(t,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){n.executeSql("DELETE FROM "+r.storeName+" WHERE key = ?",[e],function(){t()},function(e,t){i(t)})})})["catch"](i)});return f(r,t),r}function c(e){var t=this,n=new i(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){t.executeSql("DELETE FROM "+i.storeName,[],function(){e()},function(e,t){n(t)})})})["catch"](n)});return f(n,e),n}function u(e){var t=this,n=new i(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){t.executeSql("SELECT COUNT(key) as c FROM "+i.storeName,[],function(t,n){var i=n.rows.item(0).c;e(i)},function(e,t){n(t)})})})["catch"](n)});return f(n,e),n}function d(e,t){var n=this,r=new i(function(t,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){n.executeSql("SELECT key FROM "+r.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,n){var i=n.rows.length?n.rows.item(0).key:null;t(i)},function(e,t){i(t)})})})["catch"](i)});return f(r,t),r}function l(e){var t=this,n=new i(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){t.executeSql("SELECT key FROM "+i.storeName,[],function(t,n){for(var i=[],r=0;r<n.rows.length;r++)i.push(n.rows.item(r).key);e(i)},function(e,t){n(t)})})})["catch"](n)});return f(n,e),n}function f(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}var h=this,_=this.openDatabase;if(_){var p={_driver:"webSQLStorage",_initStorage:e,iterate:o,getItem:r,setItem:s,removeItem:a,clear:c,length:u,key:d,keys:l};t["default"]=p}}.call("undefined"!=typeof window?window:self),e.exports=t["default"]}])});var r=t.exports;e.modules.define("localForage",[],function(e){e(r)})}(t),t.modules.define("cloud.Error",["component.util"],function(e,t){var n={400:"Bad Request",401:"Not Authorized",403:"Forbidden",404:"Not Found",409:"Conflict",410:"Gone",421:"Locked",423:"Too Many Requests",500:"Internal Server Error"},i=function(e){t.extend(this,{code:400},e),this.message||(this.message=n[this.code]),Error.captureStackTrace?Error.captureStackTrace(this,i):this.stack=(new Error).stack};t.defineClass(i,Error,{toString:function(){return this.code+" "+this.message}}),e(i)});var n=function(){this._initialized=!1,this._key=null,this._token=null};if(n.prototype.initialize=function(e){var n=t.vow.defer();return t.modules.require(["cloud.dataSyncApi.config","component.util","cloud.Error","vow","global"],function(t,i,r,o,s){
if(e)if(e.key||e.token||e.with_credentials)if(e.token)this._token=e.token,this._initialized=!0,n.resolve();else if(e.with_credentials)this._withCredentials=!0,this._initialized=!0,n.resolve();else{var a=s.open(t.oauthLoginPage.replace(/{{\s*key\s*}}/g,e.key),"oauth",t.oauthWindowParameters);if(a)var c=s.setInterval(function(){if(a.closed)s.clearInterval(c),n.reject(new r({code:401}));else try{var e=a.location.hash.match(/access_token=([0-9a-f]+)/);e&&(this._token=e[1],this._initialized=!0,a.close(),s.clearInterval(c),n.resolve(this._token))}catch(t){}}.bind(this),100);else n.reject(new r({code:401}))}else n.reject(new r({message:"Either `options.key` or `options.token` Parameter Required"}));else n.reject(new r({message:"`options` Parameter Required"}))}.bind(this)),n.promise()},n.prototype.isInitialized=function(){return this._initialized},n.prototype.isInitiaized=n.prototype.isInitialized,n.prototype.getToken=function(){return this._token},n.prototype.withCredentials=function(){return this._withCredentials},t.cloud.client=new n,t.modules.define("cloud.client",[],function(e){e(t.cloud.client)}),t.cloud.dataSyncApi={openDatabase:function(e){return this._require(["cloud.dataSyncApi.Database"]).spread(function(t){return new t(e)})},getDatabaseCount:function(e){return this._require(["component.util","cloud.dataSyncApi.http"]).spread(function(t,n){return n.getDatabases(t.extend({limit:0,offset:0},e)).then(function(e){return e.data.total})})},getDatabaseMetadata:function(e){if(!e||!e.database_id)return this._fail("`options.database_id` Parameter Required");var t=this._castMetadata.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.getDatabases(e).then(function(e){return t(e.data)})})},listDatabaseMetadata:function(e){if(!e||"undefined"==typeof e.offset||"undefined"==typeof e.limit)return this._fail("`options.offset` and `options.limit` Parameters Required");var t=this._castMetadata.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.getDatabases(e).then(function(e){return e.data.items.map(t)})})},createDatabase:function(e){var t=this._fail.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.putDatabase(e).then(function(n){return e&&!e.ignore_existing&&200==n.code?t(409,'Database "'+e.database_id+'" Already Exists'):Number(n.headers.etag)},this)})},deleteDatabase:function(e){return this._require(["cloud.dataSyncApi.http"]).spread(function(t){return t.deleteDatabase(e).then(function(){return null})})},closeAllDatabases:function(){return this._require(["cloud.dataSyncApi.Database"]).then(function(e){return e.closeAll(),null})},_require:function(e){var n=t.vow.defer();return t.modules.require(e,function(){n.resolve([].slice.call(arguments))}),n.promise()},_castMetadata:function(e){return{database_id:e.database_id,revision:e.revision,title:e.title,created:new Date(e.created),modified:new Date(e.modified),records_count:e.records_count,size:e.size}},_fail:function(e,n){n||(n=e,e=400);var i=t.vow.defer();return t.modules.require(["cloud.Error"],function(t){i.reject(new t({code:e,message:n}))}),i.promise()}},t.modules.define("cloud.dataSyncApi",[],function(e){e(t.cloud.dataSyncApi)}),t.modules.define("component.util",function(e){var t={augment:function(e,n,i){return e.prototype=(Object.create||function(e){function t(){}return t.prototype=e,new t})(n.prototype),e.prototype.constructor=e,e.superclass=n.prototype,e.superclass.constructor=n,i&&t.extend(e.prototype,i),e.prototype},extend:function(e){for(var t=1,n=arguments.length;t<n;t++){var i=arguments[t];if(i)for(var r=Object.keys(i),o=0,s=r.length;o<s;o++)e[r[o]]=i[r[o]]}return e},defineClass:function(e){var n=1,i="function"==typeof arguments[n]?arguments[n++]:null;i&&t.augment(e,i);for(var r=arguments.length;n<r;)t.extend(e.prototype,arguments[n++]);return e},cancelableCallback:function(e){var t=!1,n=function(){t||e.apply(null,[].slice.call(arguments))};return n.cancel=function(){t=!0},n}};e(t)}),t.modules.define("component.xhr",["global","vow","cloud.Error"],function(e,t,n,i){var r=t.XMLHttpRequest,o=function(e){return e.split("\r\n").reduce(function(e,t){var n=t.split(": ");return 2==n.length&&(e[n[0].toLowerCase()]=n[1].trim()),e},{})};e(function(e,s){s=s||{},s.queryParams&&(e+=(e.indexOf("?")==-1?"?":"&")+Object.keys(s.queryParams).map(function(e){return e+"="+t.encodeURIComponent(s.queryParams[e])}).join("&"));var a=n.defer(),c=new r,u=s.headers||{},d=s.method||"GET";return"GET"==d||u["Content-Type"]||(u["Content-Type"]="application/json"),u["X-Requested-With"]||(u["X-Requested-With"]="XMLHttpRequest"),c.onload=function(){var e={code:this.status,data:this.responseText,headers:"undefined"==typeof s.parseResponseHeaders||s.parseResponseHeaders?o(this.getAllResponseHeaders()):this.getAllResponseHeaders()};if(s.parse)try{e.data=JSON.parse(e.data)}catch(t){a.reject(new i({message:"JSON Parse Error "+e.data}))}a.resolve(e)},c.onerror=function(){a.reject(new i({code:500}))},c.open(d,e,!0),Object.keys(u).forEach(function(e){c.setRequestHeader(e,u[e])}),s.withCredentials&&(c.withCredentials=!0),"undefined"!=typeof s.data?c.send("string"==typeof s.data?s.data:JSON.stringify(s.data)):c.send(),a.promise().timeout(s.timeout||3e4).fail(function(e){throw e instanceof n.TimedOutError?new i({code:500,message:"Timeout Exceeded"}):e})})}),t.modules.define("cloud.dataSyncApi.Conflict",["component.util"],function(e,t){var n=function(e){this._type=e.type,this._fieldChangeConflicts=e.field_change_conflicts};t.defineClass(n,{getType:function(){return this._type},getFieldChangeConflicts:function(){return this._fieldChangeConflicts}}),e(n)}),t.modules.define("cloud.dataSyncApi.Database",["cloud.dataSyncApi.config","cloud.dataSyncApi.http","cloud.client","cloud.dataSyncApi.DatasetController","cloud.dataSyncApi.watcher","cloud.dataSyncApi.Transaction","cloud.dataSyncApi.Operation","cloud.dataSyncApi.politics","cloud.Error","component.util","vow"],function(e,t,n,i,r,o,s,a,c,u,d,l){function f(e,t,n){var i=t.operations,r=e.dryRun(t.base_revision,i),o=r.conflicts;return o.length&&n&&(i=c[n](i,o),r=e.dryRun(t.base_revision,i),o=r.conflicts),{operations:i,conflicts:o,revisionHistory:r.revisionHistory}}var h=[],_=function(e){return this._id=e.database_id,this._context=e.context,this._token=e.token,this._locked=!0,this._datasetController=null,this._pendingCallbacks=[],this._possiblyMissedDelta=null,this._missedDelta=null,this._datasetController=null,this._collectionId=e.collection_id,this._listeners={update:[]},h.push(this),r.create(e).then(function(t){return this._datasetController=t,this._locked=!1,(e.background_sync||"undefined"==typeof e.background_sync)&&(this._watchCallback=this.update.bind(this),o.subscribe(this,this._watchCallback)),this},null,this)};_.closeAll=function(){h.slice().forEach(function(e){e.close()})},d.defineClass(_,{on:function(e,t){if("undefined"==typeof this._listeners[e])throw new u({message:"Event `"+e+"` is not supported"});if("function"!=typeof t)throw new u({message:"`callback` parameter must be a function"});return this._listeners[e].push(t),this},off:function(e,t){if("undefined"==typeof this._listeners[e])throw new u({message:"Event `"+e+"` is not supported"});var n=this._listeners[e].indexOf(t);if(n==-1)throw new u({code:404,message:"Callback not found"});return this._listeners[e].splice(n,1),this},_notify:function(e,t){var n=(this._listeners[e]||[]).slice();n.forEach(function(e){e(t)})},update:function(){return this._executeExclusiveTask(this._explicitUpdate.bind(this))},close:function(){this._watchCallback&&(o.unsubscribe(this,this._watchCallback),this._watchCallback=null),this._datasetController&&(this._datasetController.close(),this._datasetController=null),this._locked=!0;var e=h.indexOf(this);e!=-1&&h.splice(e,1)},_explicitUpdate:function(){var e=this.getRevision();return this._datasetController.update({possiblyMissedDelta:this._possiblyMissedDelta}).then(function(t){return t.missedDeltaFound&&(this._missedDelta=this._possiblyMissedDelta,this._possiblyMissedDelta=null),t.revision!=e&&this._notify("update",t.revision),t.revision},null,this)},_executeExclusiveTask:function(e){var t=this._datasetController.isGone();if(t)return t;var n=l.defer();return this._pendingCallbacks.push([e,n]),this._locked||this._proceedPendingQueue(),n.promise()},_proceedPendingQueue:function(){var e=this._pendingCallbacks.shift(),t=e[0],n=e[1];this._locked=!0,t().then(function(e){n.resolve(e),this._locked=!1,this._pendingCallbacks.length&&this._proceedPendingQueue()},function(e){n.reject(e),this._locked=!1,this._pendingCallbacks.length&&this._proceedPendingQueue()},this)},getRevision:function(){return this._datasetController.getDataset().getRevision()},getDatabaseId:function(){return this._id},getContext:function(){return this._context},createTransaction:function(){return new s(this,function(e,t){return this._executeExclusiveTask(this._patch.bind(this,e,t))}.bind(this),this._collectionId)},_patch:function(e,t){var n=l.defer(),i=this._datasetController.getDataset(),r=e.delta_id,o=function(){n.resolve(i.getRevision())},s=function(e){e.postDeltaFail&&(this._possiblyMissedDelta=e.postDeltaFail),n.reject(e)}.bind(this);if(this._missedDelta&&r==this._missedDelta)this._missedDelta=null,o();else{var c=f(i,e,t),d=c.operations,h=c.conflicts,_=c.revisionHistory,p={base_revision:this.getRevision(),delta_id:e.delta_id,changes:d.map(a.json.serialize)};h.length?s(new u({code:409,conflicts:h,revisionHistory:_})):d.length?this._postDeltas({database_id:this._id,delta_id:r,base_revision:this.getRevision(),context:this._context,token:this._token,data:p}).then(function(e){p.revision=e,i.applyDeltas([p]),o(),this._notify("update",e)},function(n){409==n.code?this._explicitUpdate().then(function(){this._patch(e,t).then(o,s)},s,this):s(n)},this):o()}return n.promise()},_postDeltas:function(e){var t=l.defer(),i=function(e){t.reject(e)};return n.postDeltas(e).then(function(n){200==n.code||201==n.code?t.resolve(Number(n.headers.etag)):(n.code>=500&&(n.postDeltaFail=e.delta_id),i(new u(n)))},function(t){t.postDeltaFail=e.delta_id,i(t)},this),t.promise()},getRecord:function(e,t){return this._datasetController.getDataset().getRecord(e,t)},getRecordsCount:function(){return this._datasetController.getDataset().getLength()},iterator:function(e){return this._datasetController.getDataset().iterator(e)},forEach:function(e,t,n){"string"!=typeof e&&(n=t,t=e,e=null);for(var i=this._datasetController.getDataset().iterator(e),r=i.next(),o=0;!r.done;)t.call(n||null,r.value,o++),r=i.next();return this},filter:function(e,t,n){this.forEach(function(i,r){e(i,r)&&t.call(n||null,i,r)})}}),e(_)}),t.modules.define("cloud.dataSyncApi.Dataset",["cloud.dataSyncApi.Record","cloud.dataSyncApi.Operation","cloud.dataSyncApi.FieldOperation","cloud.dataSyncApi.Conflict","cloud.Error","component.util"],function(e,t,n,i,r,o,s){function a(e){return Object.keys(e).reduce(function(t,n){return t[n]=Object.keys(e[n]).reduce(function(e,t){return e[t]=!0,e},{}),t},{})}function c(e){return e.map(function(e){return n.json.deserialize(e)})}var u=function(e,n,i){var r=this._index={},a=this._collectionId=i&&i.collection_id,c=i&&i.collection_policy||"restrict";this._revision=Number(e),this._revisionHistory=[],this._records=n.map(function(e){return e instanceof t||(a&&!e.collection_id&&(e=s.extend({collection_id:a},e)),e=new t(e)),e}),a&&(this._records=this._records.filter(function(e){if(e.getCollectionId()!=a){if("restrict"==c)throw new o({message:"`collection_id` Must Match Current Filter"});return!1}return!0})),this._records.forEach(function(e){var t=e.getCollectionId(),n=e.getRecordId();if(r[t]||(r[t]={}),r[t][n])throw new o({message:"Record with `collection_id` and `record_id` Provided Already Exists",collection_id:t,record_id:n});return r[t][n]=e,e})};u.json={deserialize:function(e,n){return new u(e.revision,e.records.items.map(function(e){return t.json.deserialize(e)}),n)},serialize:function(e){for(var n=[],i=e.iterator(),r=i.next();!r.done;)n.push(t.json.serialize(r.value)),r=i.next();return{revision:e.getRevision(),records:{items:n}}}},s.defineClass(u,{getRecord:function(e,t){if(this._collectionId)if(t){if(e!=this._collectionId)throw new o({message:"`collection_id` Parameter Must Match Collection Filter"})}else t=e,e=this._collectionId;if(!e)throw new o({message:"`collection_id` Parameter Required"});if(!t)throw new o({message:"`record_id` Parameter Required"});return this._index[e]&&this._index[e][t]},getRevision:function(){return this._revision},getLength:function(){return this._records.length},getCollectionId:function(){return this._collectionId},iterator:function(e){var t=-1,n=this._records;return{next:function(){if(e){do t++;while(t<n.length&&n[t].getCollectionId()!=e)}else t++;return t<n.length?{value:n[t]}:{done:!0}}}},applyDeltas:function(e){var n=this._index,r=this._revisionHistory,s=this._revision,a=this._collectionId;e.forEach(function(e){var c={};if(e.base_revision!=s)throw new o({message:"Incorrect delta base_revision"});e.changes.forEach(function(e){var r=e.collection_id,o=e.record_id;if(!a||r==a)switch(c[r]||(c[r]={}),c[r][o]=!0,e.change_type){case"insert":case"set":n[r]||(n[r]={}),n[r][o]=t.json.deserialize(e,!0);break;case"delete":delete n[r][o];break;case"update":var s=n[r][o];e.changes.forEach(function(e){s.applyFieldOperation(i.json.deserialize(e))})}}),r.push({base_revision:e.base_revision,delta_id:e.delta_id,revision:e.revision,alteredRecords:c,changes:e.changes}),s=e.revision});var c=this._records=[];Object.keys(n).forEach(function(e){Object.keys(n[e]).forEach(function(t){c.push(n[e][t])})}),this._revision=s},ifModifiedSince:function(e){var t=e.collection_id||this._collectionId,n=e.record_id,i=e.revision,r=this._locateRevision(i);if(r!=-1)for(var o=r;o<this._revisionHistory.length;o++){var s=this._revisionHistory[o];if(s.alteredRecords[t]&&s.alteredRecords[t][n])return!0}return!1},_locateRevision:function(e){for(var t=0;t<this._revisionHistory.length;t++)if(this._revisionHistory[t].base_revision==e)return t;return-1},dryRun:function(e,i){var o=[],s=a(this._index),c=this._index,u=this._collectionId;return i.forEach(function(i,a){var d=i.getCollectionId(),l=i.getRecordId();if(!u||d==u)if(this.ifModifiedSince({collection_id:d,record_id:l,revision:e}))o.push({index:a,conflict:new r({type:"both_modified",operation:i})});else switch(i.getType()){case"insert":s[d]&&s[d][l]?o.push({index:a,conflict:new r({type:"record_already_exists",operation:i})}):(s[d]||(s[d]={}),s[d][l]=t.json.deserialize(n.json.serialize(i),!0));break;case"set":s[d]||(s[d]={}),s[d][l]=t.json.deserialize(n.json.serialize(i),!0);break;case"delete":s[d]&&s[d][l]?delete s[d][l]:o.push({index:a,conflict:new r({type:"delete_non_existent_record",operation:i})});break;case"update":if(s[d]&&s[d][l]){var f=s[d][l],h=[];f===!0&&(f=c[d][l].copy()),i.getFieldOperations().forEach(function(e,t){var n=f.dryRun(e);n?h.push({type:n,index:t}):f.applyFieldOperation(e)}),h.length?o.push({index:a,conflict:new r({type:"invalid_field_change",operation:i,field_change_conflicts:h})}):s[d][l]=f}else o.push({index:a,conflict:new r({type:"update_non_existent_record",operation:i})})}},this),{conflicts:o,revisionHistory:o.length?this._getRevisionHistory(e):[]}},_getRevisionHistory:function(e){var t=this._locateRevision(e);if(t!=-1){for(var n=[],i=t;i<this._revisionHistory.length;i++){var r=this._revisionHistory[i];n.push({base_revision:r.base_revision,revision:r.revision,delta_id:r.delta_id,operations:c(r.changes)})}return n}return[]}}),e(u)}),t.modules.define("cloud.dataSyncApi.DatasetController",["cloud.dataSyncApi.config","cloud.dataSyncApi.http","cloud.dataSyncApi.Dataset","cloud.dataSyncApi.cache","cloud.Error","component.util","vow"],function(e,t,n,i,r,o,s,a){function c(e,i){var r=[],c=a.defer(),u=function(e){c.reject(e)},d=function(i){return n.getDeltas(s.extend({},e,{base_revision:i,limit:t.deltaLimit})).then(function(e){if(200==e.code)return e.data;throw new o({code:e.code})})},l=function(e){var t=e.revision;r.push(e.items);var n=e.items.length?e.items[e.items.length-1].revision:t;n==t?f():d(n).then(l,u)},f=function(){r=[].concat.apply([],r),c.resolve(r)};return d(i).then(l,u),c.promise()}var u=function(e){return this._options=e||{},this._gone=!1,this._updatePromise=null,this._dataset=null,this._createDataset().then(function(){return this},null,this)};u.create=function(e){return new u(e)},s.defineClass(u,{getDataset:function(){return this._dataset},isGone:function(){return this._gone},close:function(){this._onGone()},_createDataset:function(){return n.putDatabase(this._options).then(function(e){if(200!=e.code&&201!=e.code)throw new o({code:e.code});return this._getSnapshot(e.data)},null,this)},_getSnapshot:function(e){var t=this._options,n=this._databaseHandle=e.handle;return n&&t.use_client_storage?r.getDataset(t.context,n,t.collection_id).then(function(e){return this._initDataset(e,{need_update:!0})},function(){return this._getHttpSnapshot()},this):this._getHttpSnapshot()},_getHttpSnapshot:function(){var e=this._options;return n.getSnapshot(this._options).then(function(t){if(200==t.code)return this._initDataset(i.json.deserialize(t.data,{collection_id:e.collection_id}));throw new o({code:t.code})},null,this)},_initDataset:function(e,t){var n=this._options;return this._dataset=e,t&&t.need_update?this.update().fail(function(e){if(410==e.code)return this._getHttpSnapshot(n);throw e},this):this._saveSnapshot().always(function(){return a.resolve()})},_saveSnapshot:function(){return this._options.use_client_storage&&this._databaseHandle?r.saveDataset(this._options.context,this._databaseHandle,this._dataset):a.resolve()},update:function(e){return this._gone?this._gone:(this._updatePromise||(this._updatePromise=this._applyDeltas(e).then(function(e){return this._saveSnapshot().always(function(){return this._updatePromise=null,e},this)},function(e){throw 410==e.code&&this._onGone(),this._updatePromise=null,e},this)),this._updatePromise)},_applyDeltas:function(e){var t=this._dataset;return c(this._options,t.getRevision()).then(function(n){n.length&&t.applyDeltas(n);var i=!1;return e&&e.possiblyMissedDelta&&n.forEach(function(t){t.delta_id==e.possiblyMissedDelta&&(i=!0)}),{revision:t.getRevision(),missedDeltaFound:i}})},_onGone:function(){this._gone=a.reject({code:410,message:"Database snapshot outdated"})}}),e(u)}),t.modules.define("cloud.dataSyncApi.FieldOperation",["component.util","cloud.dataSyncApi.Value"],function(e,t,n){var i=function(e){this._type=e.type,this._fieldId=e.field_id,["set","list_item_set","list_item_insert"].indexOf(this._type)!=-1?this._value=e.value instanceof n?e.value:new n(e.value):this._value=null,["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(this._type)!=-1?this._index=Math.floor(e.index):this._index=null,"list_item_move"==this._type?this._newIndex=Math.floor(e.new_index):this._newIndex=null};i.json={serialize:function(e){var t=e.getType(),i={field_id:e.getFieldId(),change_type:t};return"set"!=t&&"list_item_set"!=t&&"list_item_insert"!=t||(i.value=n.json.serialize(e.getValue())),"list_item_move"==t&&(i.list_item_dest=e.getNewIndex()),0==t.indexOf("list_item_")&&(i.list_item=e.getIndex()),i},deserialize:function(e){var t=e.change_type,r={type:t,field_id:e.field_id};return"set"!=t&&"list_item_set"!=t&&"list_item_insert"!=t||(r.value=n.json.deserialize(e.value)),"list_item_move"==t&&(r.new_index=e.list_item_dest),0==t.indexOf("list_item_")&&(r.index=e.list_item),new i(r)}},t.defineClass(i,{getType:function(){return this._type},getFieldId:function(){return this._fieldId},getValue:function(){return this._value},getIndex:function(){return this._index},getNewIndex:function(){return this._newIndex}}),e(i)}),t.modules.define("cloud.dataSyncApi.Operation",["cloud.dataSyncApi.FieldOperation","cloud.dataSyncApi.Record","component.util"],function(e,t,n,i){var r=function(e){this._type=e.type,this._collectionId=e.collection_id,this._recordId=e.record_id,["insert","update","set"].indexOf(this._type)!=-1?this._fieldOperations=(e.field_operations||[]).map(function(e){return e instanceof t?e:new t(e)}):this._fieldOperations=null};r.json={serialize:function(e){var n=e.getType(),i={record_id:e.getRecordId(),collection_id:e.getCollectionId(),change_type:n};return["insert","update","set"].indexOf(n)!=-1&&(i.changes=e.getFieldOperations().map(function(e){return t.json.serialize(e)})),i},deserialize:function(e){var n=e.change_type,i={type:n,record_id:e.record_id,collection_id:e.collection_id};return["insert","update","set"].indexOf(this._type)!=-1&&(i.field_changes=e.changes.map(function(e){return t.json.deserialize(e)})),new r(i)}},i.defineClass(r,{getType:function(){return this._type},getRecordId:function(){return this._recordId},getCollectionId:function(){return this._collectionId},getFieldOperations:function(){return this._fieldOperations?this._fieldOperations.slice():null}}),e(r)}),t.modules.define("cloud.dataSyncApi.Record",["cloud.Error","component.util","cloud.dataSyncApi.Value"],function(e,t,n,i){var r=function(e){this._collectionId=e.collection_id,this._recordId=e.record_id,this._fields=Object.keys(e.fields||{}).reduce(function(t,n){return t[n]=e.fields[n]instanceof i?e.fields[n]:new i(e.fields[n]),t},{})};r.json={deserialize:function(e,n){return new r(n||!e.fields?{collection_id:e.collection_id,record_id:e.record_id,fields:(e.changes||[]).reduce(function(e,n){if("set"!=n.change_type)throw new t({message:"Field change type is not supported",type:n.change_type});return e[n.field_id]=i.json.deserialize(n.value),e},{})}:{collection_id:e.collection_id,record_id:e.record_id,fields:e.fields.reduce(function(e,t){return e[t.field_id]=i.json.deserialize(t.value),e},{})})},serialize:function(e){return{record_id:e.getRecordId(),collection_id:e.getCollectionId(),change_type:"set",changes:e.getFieldIds().map(function(t){return{field_id:t,change_type:"set",value:i.json.serialize(e.getFieldValue(t))}})}}},n.defineClass(r,{getCollectionId:function(){return this._collectionId},getRecordId:function(){return this._recordId},getFieldIds:function(){return Object.keys(this._fields)},getFieldValue:function(e){return this._fields[e]},getFields:function(){return n.extend({},this._fields)},applyFieldOperation:function(e){var n=this.dryRun(e);if(n)throw new t({code:409,type:n});var i=e.getFieldId(),r=e.getType(),o=this._fields,s=o[i];return"set"==r?this._fields[i]=e.getValue():"delete"==r?delete this._fields[i]:["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(r)!=-1&&s.applyListOperation(e),this},copy:function(){var e=this._fields;return new r({collection_id:this.getCollectionId(),record_id:this.getRecordId(),fields:Object.keys(this._fields).reduce(function(t,n){return t[n]=e[n].copy(),t},{})})},dryRun:function(e){var t=e.getFieldId(),n=e.getType(),i=this._fields,r=i[t];return"set"==n?null:"delete"!=n?["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(n)!=-1?"undefined"==typeof r?"modify_non_existent_field":"list"!=r.getType()?"modify_not_a_list_field":r.dryRun(e):"unknown_type":"undefined"==typeof r?"delete_non_existent_field":null}}),e(r)}),t.modules.define("cloud.dataSyncApi.Transaction",["cloud.dataSyncApi.Record","cloud.dataSyncApi.Operation","cloud.dataSyncApi.FieldOperation","component.util"],function(e,t,n,i,r){function o(e,n,i){var r={type:e};if(n instanceof t?(r.collection_id=n.getCollectionId(),r.record_id=n.getRecordId()):(r.collection_id=n.collection_id||i,r.record_id=n.record_id),i&&r.collection_id!=i)throw new Error("`collection_id` Parameter Must Match Current Filter");return r}var s=function(e,t,n){this._database=e,this._patchCallback=t,this._deltaId="ya_cloud_data_js_api_1_"+Math.random().toString(),this._baseRevision=e.getRevision(),this._operations=[],this._collectionId=n};r.defineClass(s,{addOperations:function(e){var t=this._collectionId;return this._operations=this._operations.concat([].concat(e).map(function(e){if(e instanceof n||(t&&!e.collectionId&&(e=r.extend({collection_id:t},e)),e=new n(e)),t&&e.getCollectionId()!=t)throw new Error("`collection_id` Parameter Value Must Match Current Filter");return e})),this},push:function(e){return this._patchCallback({delta_id:this._deltaId,base_revision:this._baseRevision,operations:this._operations},e)},getDatabase:function(){return this._database},getBaseRevision:function(){return this._baseRevision},getOperations:function(){return this._operations.slice()},insertRecords:function(e){var r=this._collectionId;return this.addOperations([].concat(e).map(function(e){var s=o("insert",e,r);return e instanceof t?s.field_operations=e.getFieldIds().map(function(t){return new i({type:"set",field_id:t,value:e.getFieldValue(t)})}):s.field_operations=e.fields?Object.keys(e.fields).map(function(t){return new i({type:"set",field_id:t,value:e.fields[t]})}):[],new n(s)}))},deleteRecords:function(e){var t=this._collectionId;return this.addOperations([].concat(e).map(function(e){return new n(o("delete",e,t))}))},setRecordFields:function(e,t){var r=o("set",e,this._collectionId);return Array.isArray(t)?r.field_operations=t:r.field_operations=Object.keys(t||{}).map(function(e){return new i({type:"set",field_id:e,value:t[e]})}),this.addOperations(new n(r))},updateRecordFields:function(e,t){var r=o("update",e,this._collectionId);return Array.isArray(t)?r.field_operations=t:r.field_operations=Object.keys(t).map(function(e){return new i("undefined"==typeof t[e]?{type:"delete",field_id:e}:{type:"set",field_id:e,value:t[e]})}),this.addOperations(new n(r))},insertRecordFieldListItem:function(e,t){var r=o("update",e,this._collectionId);return r.field_operations=[new i({type:"list_item_insert",field_id:t.field_id,index:t.index,value:t.value})],this.addOperations(new n(r))},setRecordFieldListItem:function(e,t){var r=o("update",e,this._collectionId);return r.field_operations=[new i({type:"list_item_set",field_id:t.field_id,index:t.index,value:t.value})],this.addOperations(new n(r))},moveRecordFieldListItem:function(e,t){var r=o("update",e,this._collectionId);return r.field_operations=[new i({type:"list_item_move",field_id:t.field_id,index:t.index,new_index:t.new_index})],this.addOperations(new n(r))},deleteRecordFieldListItem:function(e,t){var r=o("update",e,this._collectionId);return r.field_operations=[new i({type:"list_item_delete",field_id:t.field_id,index:t.index})],this.addOperations(new n(r))}}),e(s)}),t.modules.define("cloud.dataSyncApi.Value",["component.util","cloud.Error","global"],function(e,t,n,i){function r(e){switch(typeof e){case"number":return e==Number.POSITIVE_INFINITY?"inf":e==Number.NEGATIVE_INFINITY?"ninf":i.isNaN(e)?"nan":"double";case"string":return"string";case"boolean":return"boolean";case"object":return null==e?"null":"undefined"!=typeof i.ArrayBuffer&&(e instanceof i.ArrayBuffer||e.buffer&&e.buffer instanceof i.ArrayBuffer)?"binary":e instanceof Date?"datetime":e instanceof Boolean?"boolean":e instanceof Number?"double":i.Array.isArray(e)?"list":"string";default:throw new n({message:"Type unknown"})}}function o(e,t){switch(e){case"string":return t.toString();case"integer":return Math.floor(Number(t));case"double":return Number(t);case"boolean":return t instanceof Boolean?t.valueOf():Boolean(t);case"datetime":return t instanceof Date?t.toISOString():t;case"binary":return"undefined"!=typeof i.ArrayBuffer?t instanceof i.ArrayBuffer?i.btoa(String.fromCharCode.apply(null,new i.Uint8Array(t))):t.buffer&&t.buffer instanceof i.ArrayBuffer?i.btoa(String.fromCharCode.apply(null,new i.Uint8Array(t.buffer))):t.toString():t.toString();case"null":return null;case"inf":return Number.POSITIVE_INFINITY;case"ninf":return Number.NEGATIVE_INFINITY;case"nan":return Number.NaN;case"list":return t.map(function(e){return e instanceof u?e:new u(e)});default:throw new n({message:"Type unknown"})}}function s(e,t){return"list"==e?t.map(function(e){return e.copy()}):t}function a(e){e=e.replace(/[^A-Za-z0-9\+\/]/g,"");for(var t,n,r=e.length,o=3*r+1>>2,s=new i.Uint8Array(o),a=0,u=0,d=0;d<r;d++)if(n=3&d,a|=c(e.charCodeAt(d))<<18-6*n,3==n||r-d==1){for(t=0;t<3&&u<o;t++,u++)s[u]=a>>>(16>>>t&24)&255;a=0}return s.buffer}function c(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:43==e?62:47==e?63:0}var u=function(e){e&&e.type?(this._type=e.type,this._value=o(this._type,e.value)):(this._type=r(e),this._value=o(this._type,e))};u.json={serialize:function(e){var t={};return t.type=e._type,["null","nan","inf","ninf"].indexOf(t.type)!=-1?t[t.type]=!0:"list"==t.type?t.list=e._value.map(u.json.serialize):t[t.type]=e._value,t},deserialize:function(e){var t={type:e.type};return"list"==e.type?t.value=e.list?e.list.map(u.json.deserialize):[]:["null","nan","inf","ninf"].indexOf(e.type)==-1&&(t.value=e[e.type]),new u(t)}},t.defineClass(u,{getType:function(){return this._type},valueOf:function(e){return e&&"binary"==this._type?a(this._value):"datetime"==this._type?new Date(this._value):this._value},toString:function(){return this._value.toString()},copy:function(){return new u({type:this._type,value:s(this._type,this._value)})},applyListOperation:function(e){var t=this.dryRun(e);if(t)throw new n({code:409,type:t});var i=e.getType(),r=e.getIndex(),o=this._value;switch(i){case"list_item_set":o[r]=e.getValue();break;case"list_item_move":var s=o[r],a=e.getNewIndex();r!=a&&(o.splice(r,1),o.splice(a,0,s));break;case"list_item_insert":o.splice(r,0,e.getValue());break;case"list_item_delete":o.splice(r,1)}return this},dryRun:function(e){var t=e.getType(),n=e.getIndex(),i=this._value;switch(t){case"list_item_set":if(n>=i.length||n<0)return"incorrect_list_index";break;case"list_item_move":var r=e.getNewIndex();if(n>=i.length||n<0||r>=i.length||r<0)return"incorrect_list_index";break;case"list_item_insert":if(n>i.length||n<0)return"incorrect_list_index";break;case"list_item_delete":if(n>=i.length||n<0)return"incorrect_list_index";break;default:return"unknown_type"}return null}}),e(u)}),t.modules.define("cloud.dataSyncApi.cache",["localForage","vow","cloud.Error","cloud.dataSyncApi.config","cloud.dataSyncApi.Dataset"],function(e,t,n,i,r,o){function s(e,r){var s=r?{collection_id:r,collection_policy:"skip"}:null;return t.getItem(e).then(function(e){if(!e)return n.reject(new i({code:404}));try{e=o.json.deserialize(JSON.parse(e),s)}catch(t){return e=null,a.clear().always(function(){return n.reject(new i({code:500}))})}return e})}t.config({name:r.prefix,storeName:r.prefix});var a={getDatasetKey:function(e,t,n){return n?"dataset_"+e+"_"+t+"|"+n:"dataset_"+e+"_"+t},getDataset:function(e,t,n){return n?s(this.getDatasetKey(e,t,n),n).then(null,function(i){if(404==i.code)return s(this.getDatasetKey(e,t),n);throw i},this):s(this.getDatasetKey(e,t))},saveDataset:function(e,t,n){return this.saveItem(this.getDatasetKey(e,t,n.getCollectionId()),JSON.stringify(o.json.serialize(n)))},saveItem:function(e,r){return t.setItem(e,r).fail(function(){return a.clear().always(function(){return n.reject(new i({code:500}))})})},clear:function(){return t.clear()}};e(a)}),t.modules.define("cloud.dataSyncApi.config",function(e){e({apiHost:"https://cloud-api.yandex.net/",contexts:{app:!0,user:!0},oauthLoginPage:"https://oauth.yandex.ru/authorize?response_type=token&client_id={{ key }}",oauthWindowParameters:"width=600,height=500",prefix:"yandex_data_sync_api_v1",deltaLimit:100,backgroundSyncInterval:5e3})}),t.modules.define("cloud.dataSyncApi.http",["cloud.dataSyncApi.config","cloud.client","component.xhr","component.util","global","vow","cloud.Error"],function(e,t,n,i,r,o,s,a){var c=function(e){return e?u(e.context)?null:d("Invalid `options.context` Value"):d("`options` Parameter Required")},u=function(e){return e&&t.contexts[e]},d=function(e,t){return t||(t=e,e=400),s.reject(new a({code:e,message:t}))},l=function(e,t){var i=r.extend({},t);return i.headers?i.headers=r.extend({},i.headers):i.headers={},e.token?(i.headers.Authorization="OAuth "+e.token,s.resolve(i)):n.isInitialized()?(n.withCredentials()?i.withCredentials=!0:i.headers.Authorization="OAuth "+n.getToken(),
s.resolve(i)):e&&(e.authorize_if_needed||"undefined"==typeof e.authorize_if_needed)?n.initialize(e).then(function(){return n.withCredentials()?i.withCredentials=!0:i.headers.Authorization="OAuth "+n.getToken(),i}):s.reject(new a({code:401}))};e({getDatabases:function(e){var n,r=t.apiHost+"v1/data/"+e.context+"/databases";return e&&e.database_id?r+="/"+e.database_id:n={limit:Number(e&&e.limit),offset:Number(e&&e.offset)},c(e)||l(e,{queryParams:n,parse:!0}).then(function(e){return i(r,e)})},putDatabase:function(e){var n=c(e);return n||"string"==typeof e.database_id||(n=d("`options.database_id` Parameter Required")),n||l(e,{method:"PUT",parse:!0}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id,n)})},deleteDatabase:function(e){var n=c(e);return n||"string"==typeof e.database_id||(n=d("`options.database_id` Parameter Required")),n||l(e,{method:"DELETE",parse:!1}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id,n)})},getSnapshot:function(e){return c(e)||l(e,{parse:!0}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/snapshot",n)})},getDeltas:function(e){var n=c(e);return n||"string"==typeof e.database_id||(n=d("`options.database_id` Parameter Required")),n||"number"==typeof e.base_revision||(n=d("`options.base_revision` Parameter Required")),n||l(e,{method:"GET",queryParams:{base_revision:e.base_revision,limit:"undefined"==typeof e.limit?100:e.limit},parse:!0}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/deltas",n)})},postDeltas:function(e){var n=c(e);return n||"string"==typeof e.database_id||(n=d("`options.database_id` Parameter Required")),n||"number"==typeof e.base_revision||(n=d("`options.base_revision` Parameter Required")),n||"object"==typeof e.data||(n=d("`options.data` Parameter Required")),n||l(e,{method:"POST",headers:{"If-Match":e.base_revision},parse:!0,data:e.data}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/deltas",n)})},subscribe:function(e){return l(e,{parse:!0}).then(function(n){return i(t.apiHost+"v1/data/subscriptions/web?databases_ids="+encodeURIComponent(e.database_ids.join(",")),n)})}})}),t.modules.define("cloud.dataSyncApi.politics",[],function(e){e({theirs:function(e,t){var n=t.reduce(function(e,t){return e[t.index]=!0,e},{}),i=[];return e.forEach(function(e,t){n[t]||i.push(e)}),i}})}),t.modules.define("cloud.dataSyncApi.watcher",["global","cloud.dataSyncApi.config","cloud.dataSyncApi.syncEngine.PushEngine","cloud.dataSyncApi.syncEngine.PollEngine"],function(e,t,n,i,r){var o={_engine:null,_restartTimeout:null,_databases:{},subscribe:function(e,t){var n=e.getContext()+":"+e.getDatabaseId(),i=!1;this._databases[n]||(i=!0),i&&(this.getEngine().addDatabase(e),this._databases[n]={database:e,callbacks:[]}),this._databases[n].callbacks.push(t)},unsubscribe:function(e,t){var n=e.getContext()+":"+e.getDatabaseId(),i=this._databases[n],r=!1,o=i?i.callbacks.indexOf(t):-1;o!=-1&&(i.callbacks.splice(o,1),i.callbacks.length||(delete this._databases[n],r=!0)),r&&this.getEngine().removeDatabase(e)},getEngine:function(){return this._engine||this.setupEngine(),this._engine},setupEngine:function(){this._restartTimeout&&(t.clearTimeout(this._restartTimeout),this._restartTimeout=null),this._engine=this.createEngine(this._onUpdate.bind(this),this._onEngineFail.bind(this));var e=this._databases,n=Object.keys(e);n.length&&this._engine.addDatabase(n.map(function(t){return e[t].database}))},createEngine:function(e,t){var n=i.isSupported()?i:r;return new n({onUpdate:e,onFail:t})},teardownEngine:function(){this._engine&&(this._engine.removeAll(),this._engine=null)},_onUpdate:function(e,t){var n=this._databases[e];n.database.getRevision()!=t&&n.callbacks.slice().forEach(function(e){try{e(t)}catch(n){}})},_onEngineFail:function(){this.teardownEngine(),this._restartTimeout||(this._restartTimeout=t.setTimeout(function(){this._restartTimeout=null,this.setupEngine()}.bind(this),n.backgroundSyncInterval))}};e(o)}),t.modules.define("cloud.dataSyncApi.syncEngine.AbstractEngine",["global","vow","component.util","cloud.dataSyncApi.http"],function(e,t,n,i,r){var o=function(e){this._options=e||{},this._databases={},this._cancelableCallbacks=[]};o.isSupported=function(){return!0},i.defineClass(o,{addDatabase:function(e){e=[].concat(e),e.forEach(function(e){this._databases[this.getDatabaseKey(e)]={database:e,lastKnownRevision:e.getRevision()}},this),this.restart()},removeDatabase:function(e){e=[].concat(e),e.forEach(function(e){delete this._databases[this.getDatabaseKey(e)]},this),this.restart()},removeAll:function(){this._databases={},this._cancelCallbacks()},getDatabases:function(){return this._databases},addFailableCallback:function(e){this._cancelableCallbacks.push(e)},removeFailableCallback:function(e){var t=this._cancelableCallbacks.indexOf(e);t!=-1&&this._cancelableCallbacks.splice(t,1)},restart:function(){this._cancelCallbacks()},fail:function(e){this._databases=[],this._cancelCallbacks(),this._options.onFail(e)},updateRevisions:function(){return n.all(Object.keys(this._databases).map(function(e){var t=this._databases[e].database,n=i.cancelableCallback(function(t){200!=t.code?this.fail(t):(this.removeFailableCallback(n),this.checkDatabaseRevision(e,t.data.revision))}.bind(this));return this.addFailableCallback(n),r.getDatabases({context:t.getContext(),database_id:t.getDatabaseId()}).then(n,this.fail,this)}.bind(this)))},checkDatabaseRevision:function(e,t){Number(this._databases[e].lastKnownRevision)<Number(t)&&(this._databases[e].lastKnownRevision=t,this._options.onUpdate(e,t))},getDatabaseKey:function(e){return e.getContext()+":"+e.getDatabaseId()},getOptions:function(){return this._options},_cancelCallbacks:function(){this._cancelableCallbacks.slice().forEach(function(e){e.cancel()}),this._cancelableCallbacks=[]}}),e(o)}),t.modules.define("cloud.dataSyncApi.syncEngine.PollEngine",["global","component.util","cloud.dataSyncApi.config","cloud.dataSyncApi.syncEngine.AbstractEngine"],function(e,t,n,i,r){var o=function(e){o.superclass.constructor.call(this,e),this._updateTimeout=null};o.isSupported=function(){return!0},n.defineClass(o,r,{removeAll:function(){this._updateTimeout&&(t.clearTimeout(this._updateTimeout),this._updateTimeout=null),o.superclass.removeAll.call(this)},restart:function(){this._updateTimeout&&(t.clearTimeout(this._updateTimeout),this._updateTimeout=null),this.updateRevisions().then(function(){this._updateTimeout=t.setTimeout(this.restart.bind(this),this.getOptions().backgroundSyncInterval||i.backgroundSyncInterval)},this)},fail:function(e){this._updateTimeout&&(t.clearTimeout(this._updateTimeout),this._updateTimeout=null),o.superclass.fail.call(this,e)}}),e(o)}),t.modules.define("cloud.dataSyncApi.syncEngine.PushEngine",["global","component.util","cloud.dataSyncApi.http","cloud.dataSyncApi.syncEngine.AbstractEngine","cloud.Error"],function(e,t,n,i,r,o){var s=function(e){s.superclass.constructor.call(this,e),this._getSubscriptionCallback=null};s.isSupported=function(){return"function"==typeof t.WebSocket},n.defineClass(s,r,{removeAll:function(){this._teardownSocket(),s.superclass.removeAll.call(this)},restart:function(){this._teardownSocket(),s.superclass.restart.call(this);var e=Object.keys(this.getDatabases());this._getSubscriptionCallback=n.cancelableCallback(function(e){this.removeFailableCallback(this._getSubscriptionCallback),this._getSubscriptionCallback=null,200==e.code?(this._setupSocket(e.data.href),this.updateRevisions()):this.fail(new o(e))}.bind(this)),this.addFailableCallback(this._getSubscriptionCallback),i.subscribe({database_ids:e}).then(this._getSubscriptionCallback,this._fail,this)},fail:function(e){this._teardownSocket(),s.superclass.fail.call(this,e)},_setupSocket:function(e){try{this._ws=new t.WebSocket(e.replace(/^http(s)?\:/,"wss:"))}catch(n){this._ws=null,this.fail(n)}this._ws&&(this._ws.onmessage=this._onPush.bind(this),this._ws.onerror=this.fail.bind(this))},_teardownSocket:function(){this._ws&&(this._ws.onmessage=this._ws.onerror=null,this._ws.close(),this._ws=null)},_onPush:function(e){var t=JSON.parse(e.data);if("datasync_database_changed"==t.operation){var n=JSON.parse(t.message);this.checkDatabaseRevision(n.context+":"+n.database_id,n.revision)}}}),e(s)}),t.modules.define("global",function(t){t(e)}),"object"==typeof e.module)e.module.exports=t;else{var i=e.ya||(e.ya={modules:t.modules,vow:t.vow});i.cloud=t.cloud}}(this)}("undefined"!=typeof window?window:global);